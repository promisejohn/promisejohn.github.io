
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>Openstack安装部署 | Promise John</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="promise john">
    

    
    <meta name="description" content="参考架构及部署规划

操作系统：CentOS6.5
第三方yum源：epel, rdo

节点部署角色：



节点名
internal ip
public ip
Role




oscontroller
10.0.100.145
192.168.182.150
nova, glance, cinder, image, neutron, dashboard, heat


osnetwork
1">
<meta property="og:type" content="article">
<meta property="og:title" content="Openstack安装部署">
<meta property="og:url" content="http://promisejohn.github.io/2015/05/07/HelloOpenstack/index.html">
<meta property="og:site_name" content="Promise John">
<meta property="og:description" content="参考架构及部署规划

操作系统：CentOS6.5
第三方yum源：epel, rdo

节点部署角色：



节点名
internal ip
public ip
Role




oscontroller
10.0.100.145
192.168.182.150
nova, glance, cinder, image, neutron, dashboard, heat


osnetwork
1">
<meta property="og:image" content="http://docs.openstack.org/icehouse/install-guide/install/yum/content/figures/1/a/common/figures/openstack_havana_conceptual_arch.png">
<meta property="og:image" content="http://docs.openstack.org/icehouse/install-guide/install/yum/content/figures/1/figures/installguide_arch-neutron.png">
<meta property="og:image" content="http://docs.openstack.org/icehouse/install-guide/install/yum/content/figures/2/figures/SCH_5002_V00_NUAC-Keystone.png">
<meta property="og:image" content="http://docs.openstack.org/admin-guide-cloud/content/figures/14/a/a/common/figures/under-the-hood-scenario-1-ovs-compute.png">
<meta property="og:updated_time" content="2015-06-13T07:06:01.243Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Openstack安装部署">
<meta name="twitter:description" content="参考架构及部署规划

操作系统：CentOS6.5
第三方yum源：epel, rdo

节点部署角色：



节点名
internal ip
public ip
Role




oscontroller
10.0.100.145
192.168.182.150
nova, glance, cinder, image, neutron, dashboard, heat


osnetwork
1">
<meta name="twitter:creator" content="@promisejohn19">

    
    <link rel="alternative" href="/atom.xml" title="Promise John" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Promise John">Promise John</a></h1>
				<h2 class="blog-motto">My Blog</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/tags">Tags</a></li>
					
						<li><a href="/categories">categories</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:promisejohn.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/05/07/HelloOpenstack/" title="Openstack安装部署" itemprop="url">Openstack安装部署</a>
  </h1>
  <p class="article-author">By
       
		<a href="http://promisejohn.github.io/about" title="promise john" target="_blank" itemprop="author">promise john</a>
		
  <p class="article-time">
    <time datetime="2015-05-07T07:12:56.000Z" itemprop="datePublished"> 发表于 2015-05-07</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#参考架构及部署规划"><span class="toc-number">1.</span> <span class="toc-text">参考架构及部署规划</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基础环境配置"><span class="toc-number">2.</span> <span class="toc-text">基础环境配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Network_staff"><span class="toc-number">2.1.</span> <span class="toc-text">Network staff</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#配置远程登录，使用~/-ssh/config来简化远程登录操作（免密码验证）："><span class="toc-number">2.1.1.</span> <span class="toc-text">配置远程登录，使用~/.ssh/config来简化远程登录操作（免密码验证）：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置主机HostName及/etc/hosts"><span class="toc-number">2.2.</span> <span class="toc-text">配置主机HostName及/etc/hosts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置时区，启用NTP服务"><span class="toc-number">2.3.</span> <span class="toc-text">配置时区，启用NTP服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#密码准备"><span class="toc-number">2.4.</span> <span class="toc-text">密码准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据库安装配置"><span class="toc-number">2.5.</span> <span class="toc-text">数据库安装配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#消息服务安装配置"><span class="toc-number">2.6.</span> <span class="toc-text">消息服务安装配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#yum第三方源添加"><span class="toc-number">2.7.</span> <span class="toc-text">yum第三方源添加</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ID_Service:_Keystone"><span class="toc-number">3.</span> <span class="toc-text">ID Service: Keystone</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#在oskeystone上安装keystone服务："><span class="toc-number">3.1.</span> <span class="toc-text">在oskeystone上安装keystone服务：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#定义User,_tenant,_role"><span class="toc-number">3.2.</span> <span class="toc-text">定义User, tenant, role</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Openstack_Service_Clients"><span class="toc-number">4.</span> <span class="toc-text">Openstack Service Clients</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Images_Service:_Glance"><span class="toc-number">5.</span> <span class="toc-text">Images Service: Glance</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装Glance_Service"><span class="toc-number">5.1.</span> <span class="toc-text">安装Glance Service</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建Glance服务权限："><span class="toc-number">5.2.</span> <span class="toc-text">创建Glance服务权限：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#验证Glance_Service"><span class="toc-number">5.3.</span> <span class="toc-text">验证Glance Service</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Compute_Service:_Nova"><span class="toc-number">6.</span> <span class="toc-text">Compute Service: Nova</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Nova安装"><span class="toc-number">6.1.</span> <span class="toc-text">Nova安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署计算节点："><span class="toc-number">6.2.</span> <span class="toc-text">部署计算节点：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Network_Service:_Neutron_with_ML2"><span class="toc-number">7.</span> <span class="toc-text">Network Service: Neutron with ML2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#部署Neutron管理端"><span class="toc-number">7.1.</span> <span class="toc-text">部署Neutron管理端</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#在oskeystone上准备Neutron数据库："><span class="toc-number">7.1.1.</span> <span class="toc-text">在oskeystone上准备Neutron数据库：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#在oscontroller上部署配置Neutron服务端："><span class="toc-number">7.1.2.</span> <span class="toc-text">在oscontroller上部署配置Neutron服务端：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#在oscontroller上：配置Nova管理端使用Neutron管理网络："><span class="toc-number">7.1.3.</span> <span class="toc-text">在oscontroller上：配置Nova管理端使用Neutron管理网络：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#在oscontroller上启动Neutron服务："><span class="toc-number">7.1.4.</span> <span class="toc-text">在oscontroller上启动Neutron服务：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在osnetwork上配置Linux转发及Neutron_Agent"><span class="toc-number">7.2.</span> <span class="toc-text">在osnetwork上配置Linux转发及Neutron Agent</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#启用IP转发"><span class="toc-number">7.2.1.</span> <span class="toc-text">启用IP转发</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#部署配置Neutron及ML2,_OVS,_L3："><span class="toc-number">7.2.2.</span> <span class="toc-text">部署配置Neutron及ML2, OVS, L3：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置osnetwork上的dhcp组件："><span class="toc-number">7.2.3.</span> <span class="toc-text">配置osnetwork上的dhcp组件：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置metadata_agent组件："><span class="toc-number">7.2.4.</span> <span class="toc-text">配置metadata agent组件：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置oscontroller上的nova："><span class="toc-number">7.2.5.</span> <span class="toc-text">配置oscontroller上的nova：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置osnetwork上的ML2,_OVS插件："><span class="toc-number">7.2.6.</span> <span class="toc-text">配置osnetwork上的ML2, OVS插件：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动OVS，添加br-int,_br-ex为内部和外部bridge："><span class="toc-number">7.2.7.</span> <span class="toc-text">启动OVS，添加br-int, br-ex为内部和外部bridge：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动Neutron_Agent服务："><span class="toc-number">7.2.8.</span> <span class="toc-text">启动Neutron Agent服务：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在oscompute1和oscompute2上配置Linux转发及Neutron_Agent"><span class="toc-number">7.3.</span> <span class="toc-text">在oscompute1和oscompute2上配置Linux转发及Neutron Agent</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#启用Linux转发"><span class="toc-number">7.3.1.</span> <span class="toc-text">启用Linux转发</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#安装部署Neutron_ML2和OVS"><span class="toc-number">7.3.2.</span> <span class="toc-text">安装部署Neutron ML2和OVS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置ML2"><span class="toc-number">7.3.3.</span> <span class="toc-text">配置ML2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置OVS"><span class="toc-number">7.3.4.</span> <span class="toc-text">配置OVS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置Nova-Compute"><span class="toc-number">7.3.5.</span> <span class="toc-text">配置Nova-Compute</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#修改neutron-openvswitch-agent使用plugin-ini配置："><span class="toc-number">7.3.6.</span> <span class="toc-text">修改neutron-openvswitch-agent使用plugin.ini配置：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动nova-computer,neutron-openvswitch-agent进程"><span class="toc-number">7.3.7.</span> <span class="toc-text">启动nova-computer,neutron-openvswitch-agent进程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#初始化虚拟机的网络"><span class="toc-number">7.4.</span> <span class="toc-text">初始化虚拟机的网络</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#虚拟机网络流量通道"><span class="toc-number">7.5.</span> <span class="toc-text">虚拟机网络流量通道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删除或变更GRE通道"><span class="toc-number">7.6.</span> <span class="toc-text">删除或变更GRE通道</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dashboard"><span class="toc-number">8.</span> <span class="toc-text">Dashboard</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Block_Service:_Cinder"><span class="toc-number">9.</span> <span class="toc-text">Block Service: Cinder</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#在oscontroller上安装Cinder_Service"><span class="toc-number">9.1.</span> <span class="toc-text">在oscontroller上安装Cinder Service</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在osceph0上部署一个临时存储节点"><span class="toc-number">9.2.</span> <span class="toc-text">在osceph0上部署一个临时存储节点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建Instance云主机"><span class="toc-number">10.</span> <span class="toc-text">创建Instance云主机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Object_Service:_Swift"><span class="toc-number">11.</span> <span class="toc-text">Object Service: Swift</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建swift账号，在keystone上注册服务："><span class="toc-number">11.1.</span> <span class="toc-text">创建swift账号，在keystone上注册服务：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署存储节点"><span class="toc-number">11.2.</span> <span class="toc-text">部署存储节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在osswift0上部署proxy_server"><span class="toc-number">11.3.</span> <span class="toc-text">在osswift0上部署proxy server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动服务："><span class="toc-number">11.4.</span> <span class="toc-text">启动服务：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Heat"><span class="toc-number">12.</span> <span class="toc-text">Heat</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ceilometer"><span class="toc-number">13.</span> <span class="toc-text">Ceilometer</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#在osmeter部署Ceilmeter_Service："><span class="toc-number">13.1.</span> <span class="toc-text">在osmeter部署Ceilmeter Service：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#给计算节点部署Agent："><span class="toc-number">13.2.</span> <span class="toc-text">给计算节点部署Agent：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#给Glance、Cinder、Swift部署Agent："><span class="toc-number">13.3.</span> <span class="toc-text">给Glance、Cinder、Swift部署Agent：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#检验ceilometer效果"><span class="toc-number">13.4.</span> <span class="toc-text">检验ceilometer效果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">14.</span> <span class="toc-text">总结</span></a></li></ol>
		
		</div>
		
		<h2 id="参考架构及部署规划">参考架构及部署规划</h2><p><img src="http://docs.openstack.org/icehouse/install-guide/install/yum/content/figures/1/a/common/figures/openstack_havana_conceptual_arch.png" alt="参考架构"></p>
<ul>
<li>操作系统：CentOS6.5</li>
<li>第三方yum源：epel, rdo</li>
</ul>
<p>节点部署角色：</p>
<table>
<thead>
<tr>
<th>节点名</th>
<th>internal ip</th>
<th>public ip</th>
<th>Role</th>
</tr>
</thead>
<tbody>
<tr>
<td>oscontroller</td>
<td>10.0.100.145</td>
<td>192.168.182.150</td>
<td>nova, glance, cinder, image, neutron, dashboard, heat</td>
</tr>
<tr>
<td>osnetwork</td>
<td>10.0.100.146</td>
<td>192.168.182.151</td>
<td>ML2, OVS, L2 Agent, L3 Agent, DHCP Agent</td>
</tr>
<tr>
<td>oscompute1</td>
<td>10.0.100.147</td>
<td>192.168.182.152</td>
<td>nova-compute</td>
</tr>
<tr>
<td>oscompute2</td>
<td>10.0.100.148</td>
<td>192.168.182.153</td>
<td>nova-compute</td>
</tr>
<tr>
<td>oskeystone</td>
<td>10.0.100.149</td>
<td>192.168.182.154</td>
<td>qpid/rabbitmq, keystone, mysql， memcached</td>
</tr>
<tr>
<td>osmeter</td>
<td>10.0.100.150</td>
<td>192.168.182.155</td>
<td>ceilometer, mongodb</td>
</tr>
<tr>
<td>osswift0</td>
<td>10.0.100.139</td>
<td>192.168.182.144</td>
<td>swift0, swift-proxy-server</td>
</tr>
<tr>
<td>osswift1</td>
<td>10.0.100.140</td>
<td>192.168.182.145</td>
<td>swift1</td>
</tr>
<tr>
<td>osswift2</td>
<td>10.0.100.141</td>
<td>192.168.182.146</td>
<td>swift2</td>
</tr>
<tr>
<td>osceph0</td>
<td>10.0.100.142</td>
<td>192.168.182.147</td>
<td>ceph0</td>
</tr>
<tr>
<td>osceph1</td>
<td>10.0.100.143</td>
<td>192.168.182.148</td>
<td>ceph1 # 暂时不用</td>
</tr>
<tr>
<td>osceph2</td>
<td>10.0.100.144</td>
<td>192.168.182.149</td>
<td>ceph2 # 暂时不用</td>
</tr>
</tbody>
</table>
<p><img src="http://docs.openstack.org/icehouse/install-guide/install/yum/content/figures/1/figures/installguide_arch-neutron.png" alt="参考部署架构"></p>
<a id="more"></a>
<h2 id="基础环境配置">基础环境配置</h2><h3 id="Network_staff">Network staff</h3><h4 id="配置远程登录，使用~/-ssh/config来简化远程登录操作（免密码验证）：">配置远程登录，使用~/.ssh/config来简化远程登录操作（免密码验证）：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ssh-keygen -t rsa -P <span class="string">''</span> <span class="operator">-f</span> ~/.ssh/cloudlab150.key</span><br><span class="line">$ ssh-copy-id -i ~/.ssh/cloudlab150.key.pub root@<span class="number">192.168</span>.<span class="number">182.150</span> <span class="comment"># 这里需要输入密码一次</span></span><br></pre></td></tr></table></figure>
<p>编辑<code>~/.ssh/config</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Host oscontroller&#10;&#9;&#9;HostName 192.168.182.150&#10;&#9;&#9;User root&#10;&#9;&#9;PreferredAuthentications publickey&#10;&#9;&#9;IdentityFile ~/.ssh/cloudlab150.key</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh oscontroller</span><br></pre></td></tr></table></figure>
<p>通过脚本自动生成Key并添加到~/.ssh/config：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">for</span> i <span class="keyword">in</span> &#123;<span class="number">144</span>..<span class="number">154</span>&#125;; <span class="keyword">do</span> ssh-keygen -t rsa -P <span class="string">''</span> <span class="operator">-f</span> ~/.ssh/cloudlab<span class="variable">$i</span>.key; ssh-copy-id -i ~/.ssh/cloudlab<span class="variable">$i</span>.key.pub root@<span class="number">192.168</span>.<span class="number">182</span>.<span class="variable">$i</span> ;<span class="keyword">done</span>;</span><br><span class="line">$ <span class="keyword">for</span> i <span class="keyword">in</span> &#123;<span class="number">144</span>..<span class="number">154</span>&#125;; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="operator">-e</span> <span class="string">"Host cloudlab<span class="variable">$i</span>\n  HostName 192.168.182.<span class="variable">$i</span>\n  User root\n  PreferredAuthentications publickey\n  IdentityFile ~/.ssh/cloudlab<span class="variable">$i</span>.key"</span> &gt;&gt; ~/.ssh/config;<span class="keyword">done</span>;</span><br></pre></td></tr></table></figure>
<p>编辑<code>~/.ssh/config</code>: 根据部署规划可以添加Host别名，方便记忆</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">...&#10;Host cloudlab154 oskeystone&#10;&#9;&#9;HostName 192.168.182.154&#10;...</span><br></pre></td></tr></table></figure>
<h3 id="配置主机HostName及/etc/hosts">配置主机HostName及/etc/hosts</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/sysconfig/network</span><br><span class="line">$ hostname oskeystone <span class="comment"># 一台台配置oscontroller, osnetwork...</span></span><br></pre></td></tr></table></figure>
<p>编辑<code>/etc/hosts</code>: 可以统一配置然后通过scp等工具分发到所有节点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.182.144 osswift0&#10;192.168.182.145 osswift1&#10;192.168.182.146 osswift2&#10;192.168.182.147 osceph0&#10;192.168.182.148 osceph1&#10;192.168.182.149 osceph2&#10;192.168.182.150 oscontroller&#10;192.168.182.151 osnetwork&#10;192.168.182.152 oscompute1&#10;192.168.182.153 oscompute2&#10;192.168.182.154 oskeystone</span><br></pre></td></tr></table></figure>
<h3 id="配置时区，启用NTP服务">配置时区，启用NTP服务</h3><p>在oskeystone上部署NTP服务器，其他节点从oskeystone上同步时间：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ yum install ntp <span class="comment"># 每个节点都需要ntp client</span></span><br><span class="line">$ chkconfig ntpd on <span class="comment"># oskeystone自动启动ntpd</span></span><br></pre></td></tr></table></figure>
<p>编辑<code>/etc/ntpd.conf</code>:<br>服务器端，即oskeystone:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">...&#10;server&#9;202.112.10.60 # s1a.time.edu.cn&#10;server&#9;127.127.1.0     # local clock&#10;fudge&#9;127.127.1.0 stratum 10&#10;restrict 10.0.100.0 mask 255.255.255.0 nomodify&#10;...</span><br></pre></td></tr></table></figure>
<p>客户端：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server 10.0.100.149&#10;restrict 10.0.100.149 nomodify notrap noquery</span><br></pre></td></tr></table></figure>
<p>启动ntpd服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -F <span class="comment"># 服务器端需要开放UDP 123端口，这里简单测试直接清空</span></span><br><span class="line">$ ntpdate <span class="number">10.0</span>.<span class="number">100.149</span> <span class="comment"># 手动同步一次</span></span><br><span class="line">$ service ntpd start</span><br><span class="line">$ ntpq -p <span class="comment"># 检查时钟源</span></span><br><span class="line">$ ntpstat <span class="comment"># 检查时间同步状态</span></span><br></pre></td></tr></table></figure>
<p>调整时区：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ tzselect</span><br><span class="line">$ TZ=<span class="string">'Asia/Shanghai'</span>; <span class="built_in">export</span> TZ</span><br></pre></td></tr></table></figure>
<h3 id="密码准备">密码准备</h3><p>提前准备好安装过程中用到的密码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> KEYSTONE GLANCE NOVA CINDER NEUTRON HEAT CEILOMETER; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span><span class="string">"_DBPASS"</span> `openssl rand -hex <span class="number">10</span>`; <span class="built_in">echo</span> <span class="variable">$i</span><span class="string">"_PASS"</span> `openssl rand -hex <span class="number">10</span>`; <span class="keyword">done</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> MYSQL_PASS QPID_PASS DEMO_PASS ADMIN_PASS DASH_DBPASS METADATA_SECRET SWIFT_PASS; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span> `openssl rand -hex <span class="number">10</span>`;<span class="keyword">done</span>;</span><br></pre></td></tr></table></figure>
<p>记录好生成的输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">KEYSTONE_DBPASS 2e37d19cb04e42cf83ae&#10;KEYSTONE_PASS 86be667d6555105f9eb6 #&#19981;&#38656;&#35201;&#10;GLANCE_DBPASS 9fb6d0fddec4a6dcfa10&#10;GLANCE_PASS 7cb6a024c60dd85c0b71&#10;NOVA_DBPASS e5a43fc52ce0aaa1c7b4&#10;NOVA_PASS fd53a063286a4f22ab7b&#10;CINDER_DBPASS 791ce55fa6888c065bf3&#10;CINDER_PASS 89edec5c2869dce44c61&#10;NEUTRON_DBPASS fd535f9e2441a28a252d&#10;NEUTRON_PASS 033d164bcc70e1244be7&#10;HEAT_DBPASS 51eb27f53983633f3337&#10;HEAT_PASS 3817bfface1b24918d4b&#10;CEILOMETER_DBPASS 072aac393486f9b29235&#10;CEILOMETER_PASS eb8ed86ef2178168c458&#10;MYSQL_PASS a904019ba8cc0b14bef2&#10;QPID_PASS 232a62982a3bcdc86cba&#10;DEMO_PASS c3f7871eaa28ca146d09&#10;ADMIN_PASS b517d18b5663e8e9c2ae&#10;DASH_DBPASS 32ec0f799695e5ff6fe0&#10;METADATA_SECRET 69e2f4db01fe4100bd32&#10;SWIFT_PASS d8e42c6a28bf6eb08b76</span><br></pre></td></tr></table></figure>
<h3 id="数据库安装配置">数据库安装配置</h3><p>选择在oskeystone上安装mysql作为公共的数据库服务器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ yum install mysql mysql-server MySQL-python</span><br><span class="line">$ yum install MySQL-python <span class="comment"># 需要访问mysql的客户端需要安装python驱动，主要是oscontroller</span></span><br></pre></td></tr></table></figure>
<p>编辑<code>/etc/my.cnf</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]&#10;...&#10;bind-address = 10.0.100.149&#10;default-storage-engine = innodb&#10;innodb_file_per_table&#10;collation-server = utf8_general_ci&#10;init-connect = &#39;SET NAMES utf8&#39;&#10;character-set-server = utf8&#10;...</span><br></pre></td></tr></table></figure>
<p>启动mysql数据库：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ service mysqld start&#10;$ chkconfig mysqld on&#10;$ mysql_install_db&#10;$ mysql_secure_installation</span><br></pre></td></tr></table></figure>
<h3 id="消息服务安装配置">消息服务安装配置</h3><p>在oskeystone安装Qpid消息服务器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum install qpid-cpp-server</span><br></pre></td></tr></table></figure>
<p>暂时不做验证，编辑<code>/etc/qpidd.conf</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auth=no</span><br></pre></td></tr></table></figure>
<p>启动qpid服务端：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ service qpidd start</span><br><span class="line">$ chkconfig qpidd on</span><br></pre></td></tr></table></figure>
<h3 id="yum第三方源添加">yum第三方源添加</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y yum-plugin-priorities</span><br><span class="line">$ yum install -y http://repos.fedorapeople.org/repos/openstack/openstack-icehouse/rdo-release-icehouse-<span class="number">3</span>.noarch.rpm</span><br><span class="line">$ yum install -y http://dl.fedoraproject.org/pub/epel/<span class="number">6</span>/x86_64/epel-release-<span class="number">6</span>-<span class="number">8</span>.noarch.rpm</span><br></pre></td></tr></table></figure>
<p>验证第三方源：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ yum install openstack-utils <span class="comment"># 基于crudini，对于多个值的option，需要手动修改配置</span></span><br><span class="line">$ yum install openstack-selinux</span><br></pre></td></tr></table></figure>
<p>更新组件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ yum upgrade</span><br><span class="line">$ reboot  <span class="comment"># 如果更新了kernel，需要重启</span></span><br></pre></td></tr></table></figure>
<h2 id="ID_Service:_Keystone">ID Service: Keystone</h2><p><img src="http://docs.openstack.org/icehouse/install-guide/install/yum/content/figures/2/figures/SCH_5002_V00_NUAC-Keystone.png" alt="keystone原理"><br>最关键的几个概念中，<strong>tenant</strong>最关键，它是一个资源容器，里面包含了用户、服务列表、组织、账户等资源，是用来聚集和隔离资源的单元。从第2、3步中可以看到，用户是先确定了tenant再获取对应的服务列表。而Keystone在整个过程中，对每一个步骤都进行了鉴权操作。</p>
<h3 id="在oskeystone上安装keystone服务：">在oskeystone上安装keystone服务：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ yum install openstack-keystone python-keystoneclient</span><br><span class="line">$ openstack-config --set /etc/keystone/keystone.conf \</span><br><span class="line">   database connection mysql://keystone:<span class="number">2</span>e37d19cb04e42cf83ae@<span class="number">10.0</span>.<span class="number">100.149</span>/keystone</span><br><span class="line">$ mysql -u root -p</span><br><span class="line">mysql&gt; CREATE DATABASE keystone;</span><br><span class="line">mysql&gt; GRANT ALL PRIVILEGES ON keystone.* TO <span class="string">'keystone'</span>@<span class="string">'localhost'</span> \</span><br><span class="line">  IDENTIFIED BY <span class="string">'KEYSTONE_DBPASS'</span>;</span><br><span class="line">mysql&gt; GRANT ALL PRIVILEGES ON keystone.* TO <span class="string">'keystone'</span>@<span class="string">'%'</span> \</span><br><span class="line">  IDENTIFIED BY <span class="string">'KEYSTONE_DBPASS'</span>;</span><br><span class="line">mysql&gt; <span class="built_in">exit</span></span><br><span class="line">$ chown -R keystone:keystone /var/<span class="built_in">log</span>/keystone</span><br><span class="line">$ chown -R keystone:keystone /etc/keystone/</span><br><span class="line">$ su <span class="operator">-s</span> /bin/sh -c <span class="string">"keystone-manage db_sync"</span> keystone</span><br><span class="line">$ ADMIN_TOKEN=$(openssl rand -hex <span class="number">10</span>) <span class="comment"># keystone和其他service之间的token</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$ADMIN_TOKEN</span></span><br><span class="line">$ openstack-config --set /etc/keystone/keystone.conf DEFAULT admin_token <span class="variable">$ADMIN_TOKEN</span></span><br><span class="line">$ keystone-manage pki_setup --keystone-user keystone --keystone-group keystone <span class="comment"># 使用 PKI token，效率会低，但是安全。</span></span><br><span class="line">$ chown -R keystone:keystone /etc/keystone/ssl</span><br><span class="line">$ chmod -R o-rwx /etc/keystone/ssl</span><br><span class="line">$ service openstack-keystone start</span><br><span class="line">$ chkconfig openstack-keystone on</span><br></pre></td></tr></table></figure>
<p>把过期的token从数据库删除，在log中记录，防止mysql性能恶化：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ (crontab <span class="operator">-l</span> -u keystone <span class="number">2</span>&gt;&amp;<span class="number">1</span> | grep -q token_flush) || \</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'@hourly /usr/bin/keystone-manage token_flush &gt;/var/log/keystone/keystone-tokenflush.log 2&gt;&amp;1'</span> &gt;&gt; /var/spool/cron/keystone</span><br></pre></td></tr></table></figure>
<h3 id="定义User,_tenant,_role">定义User, tenant, role</h3><p>用ADMIN_TOKEN创建管理员和普通DEMO用户账号：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> OS_SERVICE_TOKEN=b412e43d938a38122d84 <span class="comment"># 之前创建的ADMIN_TOKEN</span></span><br><span class="line">$ <span class="built_in">export</span> OS_SERVICE_ENDPOINT=http://oskeystone:<span class="number">35357</span>/v2.<span class="number">0</span></span><br><span class="line">$ keystone user-create --name=admin --pass=b517d18b5663e8e9c2ae --email=admin@tecstack.org <span class="comment"># 密码开始时已批量生成</span></span><br><span class="line">$ keystone role-create --name=admin</span><br><span class="line">$ keystone tenant-create --name=admin --description=<span class="string">"Admin Tenant"</span></span><br><span class="line">$ keystone user-role-add --user=admin --tenant=admin --role=admin</span><br><span class="line">$ keystone user-role-add --user=admin --role=_member_ --tenant=admin</span><br><span class="line">$ keystone user-create --name=demo --pass=c3f7871eaa28ca146d09 --email=demo@tecstack.org</span><br><span class="line">$ keystone tenant-create --name=demo --description=<span class="string">"Demo Tenant"</span></span><br><span class="line">$ keystone user-role-add --user=demo --role=_member_ --tenant=demo</span><br></pre></td></tr></table></figure>
<p>创建service之间互访的tenant：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ keystone tenant-create --name=service --description=<span class="string">"Service Tenant"</span></span><br></pre></td></tr></table></figure>
<p>在keystone上注册服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ keystone service-create --name=keystone --type=identity \</span><br><span class="line">  --description=<span class="string">"OpenStack Identity"</span></span><br><span class="line">$ keystone endpoint-create \</span><br><span class="line">  --service-id=$(keystone service-list | awk <span class="string">'/ identity / &#123;print $2&#125;'</span>) \</span><br><span class="line">  --publicurl=http://<span class="number">192.168</span>.<span class="number">182.154</span>:<span class="number">5000</span>/v2.<span class="number">0</span> \</span><br><span class="line">  --internalurl=http://<span class="number">10.0</span>.<span class="number">100.149</span>:<span class="number">5000</span>/v2.<span class="number">0</span> \</span><br><span class="line">  --adminurl=http://<span class="number">10.0</span>.<span class="number">100.149</span>:<span class="number">35357</span>/v2.<span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>验证keystone服务是否注册成功：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">unset</span> OS_SERVICE_TOKEN OS_SERVICE_ENDPOINT</span><br><span class="line">$ keystone --os-username=admin --os-password=b517d18b5663e8e9c2ae \</span><br><span class="line">  --os-auth-url=http://<span class="number">10.0</span>.<span class="number">100.149</span>:<span class="number">35357</span>/v2.<span class="number">0</span> token-get</span><br><span class="line">$ keystone --os-username=admin --os-password=b517d18b5663e8e9c2ae \</span><br><span class="line">  --os-tenant-name=admin --os-auth-url=http://<span class="number">10.0</span>.<span class="number">100.149</span>:<span class="number">35357</span>/v2.<span class="number">0</span> \</span><br><span class="line">  token-get	<span class="comment"># 带tenant权限</span></span><br></pre></td></tr></table></figure>
<p>新增一个环境变量设置文件<code>~/adminrc</code>简化客户端命令执行参数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> OS_USERNAME=admin</span><br><span class="line"><span class="built_in">export</span> OS_PASSWORD=b517d18b5663e8e9c2ae</span><br><span class="line"><span class="built_in">export</span> OS_TENANT_NAME=admin</span><br><span class="line"><span class="built_in">export</span> OS_AUTH_URL=http://<span class="number">10.0</span>.<span class="number">100.149</span>:<span class="number">35357</span>/v2.<span class="number">0</span></span><br><span class="line"><span class="built_in">export</span> PS1=<span class="string">'[\u@\h \W(keystone_admin)]$ '</span> <span class="comment"># 识别是否处于管理员状态</span></span><br></pre></td></tr></table></figure>
<p>验证管理员权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ source ~/adminrc&#10;$ keystone user-list</span><br></pre></td></tr></table></figure>
<p>同样也建立一个Demo普通用户的<code>~/demorc</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> OS_USERNAME=demo</span><br><span class="line"><span class="built_in">export</span> OS_PASSWORD=c3f7871eaa28ca146d09</span><br><span class="line"><span class="built_in">export</span> OS_TENANT_NAME=demo</span><br><span class="line"><span class="built_in">export</span> OS_AUTH_URL=http://<span class="number">10.0</span>.<span class="number">100.149</span>:<span class="number">35357</span>/v2.<span class="number">0</span></span><br><span class="line"><span class="built_in">export</span> PS1=<span class="string">'[\u@\h \W(keystone_demo)]$ '</span></span><br></pre></td></tr></table></figure>
<h2 id="Openstack_Service_Clients">Openstack Service Clients</h2><p>Openstack的服务端都提供RESTful API，客户端都是通过curl方式进行交互，且都是基于python2.x实现。<br>可以通过yum安装，也可以通过pip安装，也可以通过pyenv、virtualenv等创建隔离环境后安装以辅助开发多个版本，具体可以参考<a href="http://promisejohn.github.io/2015/04/15/PythonDevEnvSetting/" title="Python开发环境搭建">Python开发环境搭建</a>。这里直接安装到系统版本的python下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ yum groupinstall -y <span class="string">"Development Tools"</span> <span class="comment"># 有些依赖需要gcc编译</span></span><br><span class="line">$ yum install -y python-devel</span><br><span class="line">$ <span class="built_in">alias</span> easy_install=<span class="string">'easy_install -i http://pypi.douban.com/simple'</span> <span class="comment"># 用douban源加速</span></span><br><span class="line">$ easy_install pip</span><br></pre></td></tr></table></figure>
<p>修改pip源，<code>~/.pip/pip.conf</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[global]&#10;index-url = http://pypi.douban.com/simple</span><br></pre></td></tr></table></figure>
<p>批量安装Clients：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">for</span> i <span class="keyword">in</span> cinder nova keystone glance neutron swift heat ceilometer; <span class="keyword">do</span> pip install  <span class="string">"python-"</span><span class="variable">$i</span><span class="string">"client"</span>;<span class="keyword">done</span>;</span><br></pre></td></tr></table></figure>
<h2 id="Images_Service:_Glance">Images Service: Glance</h2><p>默认采用本地文件系统存储镜像：<code>/var/lib/glance/images/</code><br>glance-api提供API，glance-registry负责image的metadata存取查询。metadata保存在mysql，image文件本身可以存在文件系统或对象存储等。</p>
<h3 id="安装Glance_Service">安装Glance Service</h3><p>在oscontroller上部署Glance Service：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y openstack-glance python-glanceclient</span><br><span class="line">$ openstack-config --set /etc/glance/glance-api.conf database \</span><br><span class="line">  connection mysql://glance:<span class="number">9</span>fb6d0fddec4a6dcfa10@<span class="number">10.0</span>.<span class="number">100.149</span>/glance</span><br><span class="line">$ openstack-config --set /etc/glance/glance-registry.conf database \</span><br><span class="line">  connection mysql://glance:<span class="number">9</span>fb6d0fddec4a6dcfa10@<span class="number">10.0</span>.<span class="number">100.149</span>/glance</span><br></pre></td></tr></table></figure>
<p>在oskeystone上增加glance数据库：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mysql -u root -pa904019ba8cc0b14bef2&#10;mysql&#62; CREATE DATABASE glance;&#10;mysql&#62; GRANT ALL PRIVILEGES ON glance.* TO &#39;glance&#39;@&#39;localhost&#39; \&#10;IDENTIFIED BY &#39;9fb6d0fddec4a6dcfa10&#39;;&#10;mysql&#62; GRANT ALL PRIVILEGES ON glance.* TO &#39;glance&#39;@&#39;%&#39; \&#10;IDENTIFIED BY &#39;9fb6d0fddec4a6dcfa10&#39;;</span><br></pre></td></tr></table></figure>
<p>在oscontroller上同步数据库：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ chown -R glance:glance /etc/glance</span><br><span class="line">$ chown -R glance:glance /var/<span class="built_in">log</span>/glance</span><br><span class="line">$ chown -R glance:glance /var/lib/glance</span><br><span class="line">$ chown -R glance:glance /var/run/glance</span><br><span class="line">$ su <span class="operator">-s</span> /bin/sh -c <span class="string">"glance-manage db_sync"</span> glance <span class="comment"># 使用glance账户执行命令</span></span><br></pre></td></tr></table></figure>
<p>Ops，出现Warning和Error：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">...PowmInsecureWarning: Not using mpz_powm_sec.  You should rebuild using libgmp &#62;= 5 to avoid timing attack vulnerability.&#10;  _warn(&#34;Not using mpz_powm_sec.  You should rebuild using libgmp &#62;= 5 to avoid timing attack vulnerability.&#34;, PowmInsecureWarning)...</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tailf /var/log/glance/api.log&#10;... glance AttributeError: &#39;NoneType&#39; object has no attribute &#39;replace&#39; ...</span><br></pre></td></tr></table></figure>
<p>Warning可以在<a href="http://techglimpse.com/openstack-installation-errors-solutions/" title="openstack安装错误方案" target="_blank" rel="external">这个网址</a>查到解决方案：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://gmplib.org/download/gmp/gmp-<span class="number">6.0</span>.<span class="number">0</span>a.tar.bz2</span><br><span class="line">$ tar xvf gmp-<span class="number">6.0</span>.<span class="number">0</span>a.tar.bz2</span><br><span class="line">$ <span class="built_in">cd</span> gmp-<span class="number">6.0</span>.<span class="number">0</span></span><br><span class="line">$ ./configure</span><br><span class="line">$ make</span><br><span class="line">$ make check</span><br><span class="line">$ make install</span><br><span class="line">$ wget https://ftp.dlitz.net/pub/dlitz/crypto/pycrypto/pycrypto-<span class="number">2.6</span>.<span class="number">1</span>.tar.gz <span class="comment"># 从源码安装，而不是从pip，否则会有ImportError: .../_AES.so: undefined symbol: rpl_malloc错误</span></span><br><span class="line">$ tar xvf pycrypto-<span class="number">2.6</span>.<span class="number">1</span>.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> pycrypto-<span class="number">2.6</span>.<span class="number">1</span></span><br><span class="line">$ <span class="built_in">export</span> ac_cv_func_malloc_0_nonnull=yes</span><br><span class="line">$ ./configure</span><br><span class="line">$ python setup.py build</span><br><span class="line">$ python setup.py install</span><br></pre></td></tr></table></figure>
<p>出现的错误很奇怪，网上也没什么案例，只能一步步看日志trace：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">File &#34;/usr/lib/python2.6/site-packages/glance/openstack/common/db/sqlalchemy/migration.py&#34;, line 236, in db_version&#10;2015-04-22 02:43:28.196 27939 TRACE glance     meta.reflect(bind=engine)&#10;2015-04-22 02:43:28.196 27939 TRACE glance   File &#34;/usr/lib64/python2.6/site-packages/sqlalchemy/schema.py&#34;, line 2776, in reflect&#10;2015-04-22 02:43:28.196 27939 TRACE glance     connection=conn))&#10;2015-04-22 02:43:28.196 27939 TRACE glance   File &#34;/usr/lib64/python2.6/site-packages/sqlalchemy/engine/base.py&#34;, line 1677, in table_names&#10;2015-04-22 02:43:28.196 27939 TRACE glance     return self.dialect.get_table_names(conn, schema)</span><br></pre></td></tr></table></figure>
<p>可以关注的是3处关键词：<strong>bind=engine</strong>, <strong>connection=conn</strong>, <strong>get_table_names(conn, schema)</strong>，很大程度上表明数据库连接建立失败，而且是在获取schema的时候，重新检查一下<code>/etc/glance/glance-api.conf</code>，发现mysql连接最后少加了schema，即误写成了<code>mysql://glance:9fb6d0fddec4a6dcfa10@10.0.100.149/</code>，少了<code>glance</code>，改正后再执行db_sync成功。</p>
<h3 id="创建Glance服务权限：">创建Glance服务权限：</h3><p>创建Glance Service与Keystone验证的用户：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">source</span> ~/adminrc  <span class="comment"># 加载admin环境变量</span></span><br><span class="line">$ keystone user-create --name=glance --pass=<span class="number">7</span>cb6a024c60dd85c0b71 \</span><br><span class="line">   --email=glance@tecstack.org</span><br><span class="line">$ keystone user-role-add --user=glance --tenant=service --role=admin</span><br></pre></td></tr></table></figure>
<p>配置Glance Service通过Keystone进行鉴权：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">$ openstack-config --set /etc/glance/glance-api.conf keystone_authtoken \</span><br><span class="line">  auth_uri http://<span class="number">10.0</span>.<span class="number">100.149</span>:<span class="number">5000</span></span><br><span class="line">$ openstack-config --set /etc/glance/glance-api.conf keystone_authtoken \</span><br><span class="line">  auth_host <span class="number">10.0</span>.<span class="number">100.149</span></span><br><span class="line">$ openstack-config --set /etc/glance/glance-api.conf keystone_authtoken \</span><br><span class="line">  auth_port <span class="number">35357</span></span><br><span class="line">$ openstack-config --set /etc/glance/glance-api.conf keystone_authtoken \</span><br><span class="line">  auth_protocol http</span><br><span class="line">$ openstack-config --set /etc/glance/glance-api.conf keystone_authtoken \</span><br><span class="line">  admin_tenant_name service</span><br><span class="line">$ openstack-config --set /etc/glance/glance-api.conf keystone_authtoken \</span><br><span class="line">  admin_user glance</span><br><span class="line">$ openstack-config --set /etc/glance/glance-api.conf keystone_authtoken \</span><br><span class="line">  admin_password <span class="number">7</span>cb6a024c60dd85c0b71</span><br><span class="line">$ openstack-config --set /etc/glance/glance-api.conf paste_deploy \</span><br><span class="line">  flavor keystone</span><br><span class="line">$ openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken \</span><br><span class="line">  auth_uri http://<span class="number">10.0</span>.<span class="number">100.149</span>:<span class="number">5000</span></span><br><span class="line">$ openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken \</span><br><span class="line">  auth_host <span class="number">10.0</span>.<span class="number">100.149</span></span><br><span class="line">$ openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken \</span><br><span class="line">  auth_port <span class="number">35357</span></span><br><span class="line">$ openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken \</span><br><span class="line">  auth_protocol http</span><br><span class="line">$ openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken \</span><br><span class="line">  admin_tenant_name service</span><br><span class="line">$ openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken \</span><br><span class="line">  admin_user glance</span><br><span class="line">$ openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken \</span><br><span class="line">  admin_password <span class="number">7</span>cb6a024c60dd85c0b71</span><br><span class="line">$ openstack-config --set /etc/glance/glance-registry.conf paste_deploy \</span><br><span class="line">  flavor keystone</span><br></pre></td></tr></table></figure>
<p>注册Glance Service服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ keystone service-create --name=glance --type=image \</span><br><span class="line">  --description=<span class="string">"OpenStack Image Service"</span></span><br><span class="line">$ keystone endpoint-create \</span><br><span class="line">  --service-id=$(keystone service-list | awk <span class="string">'/ image / &#123;print $2&#125;'</span>) \</span><br><span class="line">  --publicurl=http://<span class="number">192.168</span>.<span class="number">182.150</span>:<span class="number">9292</span> \</span><br><span class="line">  --internalurl=http://<span class="number">10.0</span>.<span class="number">100.145</span>:<span class="number">9292</span> \</span><br><span class="line">  --adminurl=http://<span class="number">10.0</span>.<span class="number">100.145</span>:<span class="number">9292</span></span><br></pre></td></tr></table></figure>
<p>启动Glance服务进程：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ service openstack-glance-api start</span><br><span class="line">$ service openstack-glance-registry start</span><br><span class="line">$ chkconfig openstack-glance-api on</span><br><span class="line">$ chkconfig openstack-glance-registry on</span><br></pre></td></tr></table></figure>
<h3 id="验证Glance_Service">验证Glance Service</h3><p>用cirros验证镜像服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ wget http://cdn.download.cirros-cloud.net/<span class="number">0.3</span>.<span class="number">2</span>/cirros-<span class="number">0.3</span>.<span class="number">2</span>-x86_64-disk.img</span><br><span class="line">$ file cirros-<span class="number">0.3</span>.<span class="number">2</span>-x86_64-disk.img</span><br><span class="line">cirros-<span class="number">0.3</span>.<span class="number">2</span>-x86_64-disk.img: Qemu Image, Format: Qcow , Version: <span class="number">2</span></span><br><span class="line">$ <span class="built_in">source</span> ~/adminrc</span><br><span class="line">$ glance image-create --name <span class="string">"cirros-0.3.2-x86_64"</span> --disk-format qcow2 \</span><br><span class="line">  --container-format bare --is-public True --progress &lt; cirros-<span class="number">0.3</span>.<span class="number">2</span>-x86_64-disk.img</span><br><span class="line">$ glance image-list</span><br></pre></td></tr></table></figure>
<p>如果不想下载镜像，可以直接通过<code>--copy-from</code>参数直接导入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ glance image-create --name=<span class="string">"cirros-0.3.2-x86_64"</span> --disk-format=qcow2 \</span><br><span class="line">  --container-format=bare --is-public=<span class="literal">true</span> \</span><br><span class="line">  --copy-from http://cdn.download.cirros-cloud.net/<span class="number">0.3</span>.<span class="number">2</span>/cirros-<span class="number">0.3</span>.<span class="number">2</span>-x86_64-disk.img</span><br></pre></td></tr></table></figure>
<h2 id="Compute_Service:_Nova">Compute Service: Nova</h2><p>Compute是IaaS的核心，<code>nova-api</code>,<code>nova-api-metadata</code>提供API服务；<code>nova-compute</code>调用hypervisor API启停虚拟机，<code>nova-scheduler</code>从请求队列调度分配主机，<code>nova-conductor</code>把<code>nova-compute</code>和数据库解耦，可以横向扩展，不建议跟<code>nova-compute</code>一起部署；<code>nova-network</code>, <code>nova-dhcpbridge</code>，网络部分功能逐步合并到Neutron Service；<code>nova-consoleauth</code>，负责控制台鉴权，<code>nova-novncproxy</code>和<code>nova-xvpnvncproxy</code>分别对应浏览器和java客户端，<code>nova-cert</code>管理x509证书。<code>nova-objectstore</code>和<code>euca2ools</code>是针对EC2场景的工具，实现Image Service和S3的互通；<code>nova</code>,<code>nova-manage</code>是本地客户端。</p>
<h3 id="Nova安装">Nova安装</h3><p>在oscontroller上安装nova管理端：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y openstack-nova-api openstack-nova-cert openstack-nova-conductor openstack-nova-console openstack-nova-novncproxy openstack-nova-scheduler python-novaclient</span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf \</span><br><span class="line">  database connection mysql://nova:e5a43<span class="built_in">fc</span>52ce0aaa1c7b4@<span class="number">10.0</span>.<span class="number">100.149</span>/nova</span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf \</span><br><span class="line">  DEFAULT rpc_backend qpid</span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT qpid_hostname <span class="number">10.0</span>.<span class="number">100.149</span></span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT my_ip <span class="number">10.0</span>.<span class="number">100.145</span></span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT vncserver_listen <span class="number">10.0</span>.<span class="number">100.145</span></span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT vncserver_proxyclient_address <span class="number">10.0</span>.<span class="number">100.145</span></span><br></pre></td></tr></table></figure>
<p>在oskeystone上创建nova的数据库：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ mysql -u root -pa904019ba8cc0b14bef2</span><br><span class="line">mysql&gt; CREATE DATABASE nova;</span><br><span class="line">mysql&gt; GRANT ALL PRIVILEGES ON nova.* TO <span class="string">'nova'</span>@<span class="string">'%'</span> \</span><br><span class="line">IDENTIFIED BY <span class="string">'e5a43fc52ce0aaa1c7b4'</span>;</span><br></pre></td></tr></table></figure>
<p>在oscontroller上同步nova数据库：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ chown -R nova:nova /etc/nova/</span><br><span class="line">$ chown -R nova:nova /var/<span class="built_in">log</span>/nova/</span><br><span class="line">$ chown -R nova:nova /var/run/nova/</span><br><span class="line">$ chown -R nova:nova /var/lib/nova/</span><br><span class="line">$ su <span class="operator">-s</span> /bin/sh -c <span class="string">"nova-manage db sync"</span> nova</span><br></pre></td></tr></table></figure>
<p>创建Nova Service在Keystone上的账号权限，配置其使用keystone做鉴权：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ keystone user-create --name=nova --pass=fd53a063286a4f22ab7b --email=nova@tecstack.org</span><br><span class="line">$ keystone user-role-add --user=nova --tenant=service --role=admin</span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT auth_strategy keystone</span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_uri http://<span class="number">10.0</span>.<span class="number">100.149</span>:<span class="number">5000</span></span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_host <span class="number">10.0</span>.<span class="number">100.149</span></span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_protocol http</span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_port <span class="number">35357</span></span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf keystone_authtoken admin_user nova</span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf keystone_authtoken admin_tenant_name service</span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf keystone_authtoken admin_password fd53a063286a4f22ab7b</span><br></pre></td></tr></table></figure>
<p>在oskeystone上注册Nova Service：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">source</span> ~/adminrc</span><br><span class="line">$ keystone service-create --name=nova --type=compute \</span><br><span class="line">  --description=<span class="string">"OpenStack Compute"</span></span><br><span class="line">$ keystone endpoint-create \</span><br><span class="line">  --service-id=$(keystone service-list | awk <span class="string">'/ compute / &#123;print $2&#125;'</span>) \</span><br><span class="line">  --publicurl=http://<span class="number">192.168</span>.<span class="number">182.150</span>:<span class="number">8774</span>/v2/%\(tenant_id\)s \</span><br><span class="line">  --internalurl=http://<span class="number">10.0</span>.<span class="number">100.145</span>:<span class="number">8774</span>/v2/%\(tenant_id\)s \</span><br><span class="line">  --adminurl=http://<span class="number">10.0</span>.<span class="number">100.145</span>:<span class="number">8774</span>/v2/%\(tenant_id\)s</span><br></pre></td></tr></table></figure>
<p>启动Nova服务程序：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">for</span> svc <span class="keyword">in</span> openstack-nova-&#123;api,cert,consoleauth,scheduler,conductor,novncproxy&#125;; <span class="keyword">do</span> service <span class="variable">$svc</span> start; chkconfig <span class="variable">$svc</span> on; <span class="keyword">done</span>;</span><br><span class="line">$ <span class="keyword">for</span> svc <span class="keyword">in</span> openstack-nova-&#123;api,cert,consoleauth,scheduler,conductor,novncproxy&#125;; <span class="keyword">do</span> service <span class="variable">$svc</span> status; chkconfig | grep <span class="variable">$svc</span>; <span class="keyword">done</span>;  <span class="comment"># 检查进程状态及自动启动设置状态</span></span><br></pre></td></tr></table></figure>
<p>检查Nova Service部署</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">source</span> ~/adminrc</span><br><span class="line">$ nova image-list</span><br></pre></td></tr></table></figure>
<h3 id="部署计算节点：">部署计算节点：</h3><p>在oscompute1和oscompute2上安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y openstack-nova-compute</span><br><span class="line">$ egrep -c <span class="string">'(vmx|svm)'</span> /proc/cpuinfo <span class="comment"># 确定CPU支持虚拟化，如果不支持硬件虚拟化，需要配置nova.conf中的libvirt virt_type为qemu</span></span><br><span class="line"><span class="comment"># openstack-config --set /etc/nova/nova.conf libvirt virt_type qemu</span></span><br></pre></td></tr></table></figure>
<p>编辑<code>/etc/nova/nova.conf</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ openstack-config --set /etc/nova/nova.conf database connection mysql://nova:e5a43<span class="built_in">fc</span>52ce0aaa1c7b4@<span class="number">10.0</span>.<span class="number">100.149</span>/nova</span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT auth_strategy keystone</span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_uri http://<span class="number">10.0</span>.<span class="number">100.149</span>:<span class="number">5000</span></span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_host <span class="number">10.0</span>.<span class="number">100.149</span></span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_protocol http</span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf keystone_authtoken auth_port <span class="number">35357</span></span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf keystone_authtoken admin_user nova</span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf keystone_authtoken admin_tenant_name service</span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf keystone_authtoken admin_password fd53a063286a4f22ab7b</span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT rpc_backend qpid</span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT qpid_hostname <span class="number">10.0</span>.<span class="number">100.149</span></span><br></pre></td></tr></table></figure>
<p>在计算节点启用console：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT my_ip <span class="number">192.168</span>.<span class="number">182.152</span>/<span class="number">153</span></span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT vnc_enabled True</span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT vncserver_listen <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT vncserver_proxyclient_address <span class="number">192.168</span>.<span class="number">182.152</span>/<span class="number">153</span></span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf \</span><br><span class="line">  DEFAULT novncproxy_base_url http://<span class="number">192.168</span>.<span class="number">182.150</span>:<span class="number">6080</span>/vnc_auto.html</span><br></pre></td></tr></table></figure>
<p>配置Glance：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT glance_host <span class="number">10.0</span>.<span class="number">100.145</span></span><br></pre></td></tr></table></figure>
<p>启动进程服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ service libvirtd start</span><br><span class="line">$ service messagebus start</span><br><span class="line">$ service openstack-nova-compute start</span><br><span class="line">$ chkconfig libvirtd on</span><br><span class="line">$ chkconfig messagebus on</span><br><span class="line">$ chkconfig openstack-nova-compute on</span><br></pre></td></tr></table></figure>
<h2 id="Network_Service:_Neutron_with_ML2">Network Service: Neutron with ML2</h2><p>网络部分关键概念包括：networks, subnets, routes，至少有1个“外部”网络。网络功能由plugin提供，如core plugin, security group plugin, FW, LB, …</p>
<h3 id="部署Neutron管理端">部署Neutron管理端</h3><h4 id="在oskeystone上准备Neutron数据库：">在oskeystone上准备Neutron数据库：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ mysql -u root -p</span><br><span class="line">mysql&gt; CREATE DATABASE neutron;</span><br><span class="line">mysql&gt; GRANT ALL PRIVILEGES ON neutron.* TO <span class="string">'neutron'</span>@<span class="string">'%'</span> \</span><br><span class="line">IDENTIFIED BY <span class="string">'fd535f9e2441a28a252d'</span>;</span><br></pre></td></tr></table></figure>
<p>创建Neutron的keystone账号，并注册Neutron服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">source</span> ~/adminrc</span><br><span class="line">$ keystone user-create --name neutron --pass <span class="number">033</span>d164bcc70e1244be7 --email neutron@tecstack.org</span><br><span class="line">$ keystone user-role-add --user neutron --tenant service --role admin</span><br><span class="line">$ keystone service-create --name neutron --type network --description <span class="string">"OpenStack Networking"</span></span><br><span class="line">$ keystone endpoint-create \</span><br><span class="line">  --service-id $(keystone service-list | awk <span class="string">'/ network / &#123;print $2&#125;'</span>) \</span><br><span class="line">  --publicurl http://<span class="number">192.168</span>.<span class="number">182.150</span>:<span class="number">9696</span> \</span><br><span class="line">  --adminurl http://<span class="number">10.0</span>.<span class="number">100.145</span>:<span class="number">9696</span> \</span><br><span class="line">  --internalurl http://<span class="number">10.0</span>.<span class="number">100.145</span>:<span class="number">9696</span></span><br></pre></td></tr></table></figure>
<h4 id="在oscontroller上部署配置Neutron服务端：">在oscontroller上部署配置Neutron服务端：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y openstack-neutron openstack-neutron-ml2 python-neutronclient</span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf database connection \</span><br><span class="line">  mysql://neutron:fd535f9e2441a28a252d@<span class="number">10.0</span>.<span class="number">100.149</span>/neutron</span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf DEFAULT \</span><br><span class="line">  auth_strategy keystone</span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken \</span><br><span class="line">  auth_uri http://<span class="number">10.0</span>.<span class="number">100.149</span>:<span class="number">5000</span></span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken \</span><br><span class="line">  auth_host <span class="number">10.0</span>.<span class="number">100.149</span></span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken \</span><br><span class="line">  auth_protocol http</span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken \</span><br><span class="line">  auth_port <span class="number">35357</span></span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken \</span><br><span class="line">  admin_tenant_name service</span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken \</span><br><span class="line">  admin_user neutron</span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken \</span><br><span class="line">  admin_password <span class="number">033</span>d164bcc70e1244be7</span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf DEFAULT \</span><br><span class="line">  core_plugin ml2</span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf DEFAULT \</span><br><span class="line">  service_plugins router</span><br></pre></td></tr></table></figure>
<p>配置Neutron使用MQ：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ openstack-config --set /etc/neutron/neutron.conf DEFAULT \</span><br><span class="line">  rpc_backend neutron.openstack.common.rpc.impl_qpid</span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf DEFAULT \</span><br><span class="line">  qpid_hostname <span class="number">10.0</span>.<span class="number">100.149</span></span><br></pre></td></tr></table></figure>
<p>配置Neutron与计算节点的通知：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ openstack-config --set /etc/neutron/neutron.conf DEFAULT \</span><br><span class="line">  notify_nova_on_port_status_changes True</span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf DEFAULT \</span><br><span class="line">  notify_nova_on_port_data_changes True</span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf DEFAULT \</span><br><span class="line">  nova_url http://<span class="number">10.0</span>.<span class="number">100.145</span>:<span class="number">8774</span>/v2</span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf DEFAULT \</span><br><span class="line">  nova_admin_username nova</span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf DEFAULT \</span><br><span class="line">  nova_admin_tenant_id $(keystone tenant-list | awk <span class="string">'/ service / &#123; print $2 &#125;'</span>)</span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf DEFAULT \</span><br><span class="line">  nova_admin_password fd53a063286a4f22ab7b</span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf DEFAULT \</span><br><span class="line">  nova_admin_auth_url http://<span class="number">10.0</span>.<span class="number">100.149</span>:<span class="number">35357</span>/v2.<span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>创建neutron ml2 plugn配置链接：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ln <span class="operator">-s</span> plugins/ml2/ml2_conf.ini /etc/neutron/plugin.ini</span><br></pre></td></tr></table></figure>
<p>配置ML2插件：ML2使用OVS处理网络流量。在oscontroller上配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 \</span><br><span class="line">  <span class="built_in">type</span>_drivers gre</span><br><span class="line">$ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 \</span><br><span class="line">  tenant_network_types gre</span><br><span class="line">$ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 \</span><br><span class="line">  mechanism_drivers openvswitch</span><br><span class="line">$ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2_<span class="built_in">type</span>_gre \</span><br><span class="line">  tunnel_id_ranges <span class="number">1</span>:<span class="number">1000</span></span><br><span class="line">$ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini securitygroup \</span><br><span class="line">  firewall_driver neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver</span><br><span class="line">$ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini securitygroup \</span><br><span class="line">  <span class="built_in">enable</span>_security_group True</span><br></pre></td></tr></table></figure>
<h4 id="在oscontroller上：配置Nova管理端使用Neutron管理网络：">在oscontroller上：配置Nova管理端使用Neutron管理网络：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT \</span><br><span class="line">  network_api_class nova.network.neutronv2.api.API</span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT \</span><br><span class="line">  neutron_url http://<span class="number">10.0</span>.<span class="number">100.145</span>:<span class="number">9696</span></span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT \</span><br><span class="line">  neutron_auth_strategy keystone</span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT \</span><br><span class="line">  neutron_admin_tenant_name service</span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT \</span><br><span class="line">  neutron_admin_username neutron</span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT \</span><br><span class="line">  neutron_admin_password <span class="number">033</span>d164bcc70e1244be7</span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT \</span><br><span class="line">  neutron_admin_auth_url http://<span class="number">10.0</span>.<span class="number">100.149</span>:<span class="number">35357</span>/v2.<span class="number">0</span></span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT \</span><br><span class="line">  linuxnet_interface_driver nova.network.linux_net.LinuxOVSInterfaceDriver</span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT \</span><br><span class="line">  firewall_driver nova.virt.firewall.NoopFirewallDriver <span class="comment"># 禁用nova-compute内置的FW功能。</span></span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT \</span><br><span class="line">  security_group_api neutron</span><br></pre></td></tr></table></figure>
<p>在oscontroller上重启Nova服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ service openstack-nova-api restart</span><br><span class="line">$ service openstack-nova-scheduler restart</span><br><span class="line">$ service openstack-nova-conductor restart</span><br></pre></td></tr></table></figure>
<h4 id="在oscontroller上启动Neutron服务：">在oscontroller上启动Neutron服务：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ service neutron-server start</span><br><span class="line">$ chkconfig neutron-server on</span><br></pre></td></tr></table></figure>
<p>正常情况下，neutron-server在启动的时候会自动初始化数据库，如果出错，可以在oscontroller上手动建立数据库：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ openstack-config --set /etc/neutron/neutron.conf DEFAULT \</span><br><span class="line">  core_plugin neutron.plugins.ml2.plugin.Ml2Plugin</span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf DEFAULT \</span><br><span class="line">  service_plugins neutron.services.l3_router.l3_router_plugin.L3RouterPlugin</span><br><span class="line">$ su <span class="operator">-s</span> /bin/sh -c <span class="string">"neutron-db-manage --config-file /etc/neutron/neutron.conf \</span><br><span class="line">  --config-file /etc/neutron/plugin.ini upgrade head"</span> neutron</span><br></pre></td></tr></table></figure>
<h3 id="在osnetwork上配置Linux转发及Neutron_Agent">在osnetwork上配置Linux转发及Neutron Agent</h3><h4 id="启用IP转发">启用IP转发</h4><p>编辑<code>/etc/sysctl.conf</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.ip_forward=1&#10;net.ipv4.conf.all.rp_filter=0&#10;net.ipv4.conf.default.rp_filter=0&#10;net.bridge.bridge-nf-call-arptables=1&#10;net.bridge.bridge-nf-call-iptables=1&#10;net.bridge.bridge-nf-call-ip6tables=1</span><br></pre></td></tr></table></figure>
<p>使生效：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sysctl -p</span><br></pre></td></tr></table></figure>
<h4 id="部署配置Neutron及ML2,_OVS,_L3：">部署配置Neutron及ML2, OVS, L3：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y openstack-neutron openstack-neutron-ml2 \</span><br><span class="line">  openstack-neutron-openvswitch</span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf DEFAULT \</span><br><span class="line">  auth_strategy keystone</span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken \</span><br><span class="line">  auth_uri http://<span class="number">10.0</span>.<span class="number">100.149</span>:<span class="number">5000</span></span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken \</span><br><span class="line">  auth_host <span class="number">10.0</span>.<span class="number">100.149</span></span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken \</span><br><span class="line">  auth_protocol http</span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken \</span><br><span class="line">  auth_port <span class="number">35357</span></span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken \</span><br><span class="line">  admin_tenant_name service</span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken \</span><br><span class="line">  admin_user neutron</span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken \</span><br><span class="line">  admin_password <span class="number">033</span>d164bcc70e1244be7</span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf DEFAULT \</span><br><span class="line">  rpc_backend neutron.openstack.common.rpc.impl_qpid</span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf DEFAULT \</span><br><span class="line">  qpid_hostname <span class="number">10.0</span>.<span class="number">100.149</span></span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf DEFAULT \</span><br><span class="line">  core_plugin ml2</span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf DEFAULT \</span><br><span class="line">  service_plugins router</span><br><span class="line">$ openstack-config --set /etc/neutron/l3_agent.ini DEFAULT \</span><br><span class="line">  interface_driver neutron.agent.linux.interface.OVSInterfaceDriver</span><br><span class="line">$ openstack-config --set /etc/neutron/l3_agent.ini DEFAULT \</span><br><span class="line">  use_namespaces True</span><br></pre></td></tr></table></figure>
<p>官方文档对于网络包大小解释的比较清楚，直接引用如下：</p>
<p>&gt;<br>Tunneling protocols such as generic routing encapsulation (GRE) include additional packet headers that increase overhead and decrease space available for the payload or user data. Without knowledge of the virtual network infrastructure, instances attempt to send packets using the default Ethernet maximum transmission unit <strong>(MTU) of 1500 bytes</strong>. Internet protocol (IP) networks contain the path MTU discovery (<strong>PMTUD</strong>) mechanism to detect end-to-end MTU and adjust packet size accordingly. However, some operating systems and networks block or otherwise <strong>lack support for PMTUD</strong> causing performance degradation or connectivity failure.<br>&gt;<br>Ideally, you can prevent these problems by enabling <strong>jumbo frames on the physical network</strong> that contains your tenant virtual networks. Jumbo frames support MTUs up to approximately <strong>9000 bytes</strong> which negates the impact of GRE overhead on virtual networks. However, many network devices lack support for jumbo frames and OpenStack administrators often lack control of network infrastructure. Given the latter complications, you can also prevent MTU problems by <strong>reducing the instance MTU to account for GRE overhead</strong>. Determining the proper MTU value often takes experimentation, but <strong>1454 bytes</strong> works in most environments. You can configure the DHCP server that assigns IP addresses to your instances to also adjust the MTU.<br>Some cloud images such as CirrOS ignore the DHCP MTU option.</p>
<p>大致意思是默认的MTU为1500字节，当加入了GRE等tunnel包头后会超过1500字节，IP协议理论上通过PMTUD可以自动调节传输路径上的MTU大小，但有些OS和网络设备因缺乏对PMTUD的支持会拦截此类包导致通断或性能问题。Jumbo frames支持最大9000字节的MTU，但是需要硬件网络设备的支持。<br>通常情况下，可以从虚拟机端设计MTU的大小，一般1454字节（减去了GRE的包头大小）在大部分环境下可行，MTU的设置可以通过DHCP服务器配置，但有些OS如CirrOS不支持DHCP配置MTU。</p>
<h4 id="配置osnetwork上的dhcp组件：">配置osnetwork上的dhcp组件：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ openstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT \</span><br><span class="line">  interface_driver neutron.agent.linux.interface.OVSInterfaceDriver</span><br><span class="line">$ openstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT \</span><br><span class="line">  dhcp_driver neutron.agent.linux.dhcp.Dnsmasq</span><br><span class="line">$ openstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT \</span><br><span class="line">  use_namespaces True</span><br><span class="line">$ openstack-config --set /etc/neutron/dhcp_agent.ini DEFAULT \</span><br><span class="line">  dnsmasq_config_file /etc/neutron/dnsmasq-neutron.conf <span class="comment"># DHCP MTU</span></span><br></pre></td></tr></table></figure>
<p>新建编辑<code>/etc/neutron/dnsmasq-neutron.conf</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dhcp-option-force=26,1454</span><br></pre></td></tr></table></figure>
<p>停止所有dnsmasq进程：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">killall dnsmasq</span><br></pre></td></tr></table></figure>
<h4 id="配置metadata_agent组件：">配置metadata agent组件：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT \</span><br><span class="line">  auth_url http://<span class="number">10.0</span>.<span class="number">100.149</span>:<span class="number">5000</span>/v2.<span class="number">0</span></span><br><span class="line">$ openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT \</span><br><span class="line">  auth_region regionOne</span><br><span class="line">$ openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT \</span><br><span class="line">  admin_tenant_name service</span><br><span class="line">$ openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT \</span><br><span class="line">  admin_user neutron</span><br><span class="line">$ openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT \</span><br><span class="line">  admin_password <span class="number">033</span>d164bcc70e1244be7</span><br><span class="line">$ openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT \</span><br><span class="line">  nova_metadata_ip <span class="number">10.0</span>.<span class="number">100.145</span></span><br><span class="line">$ openstack-config --set /etc/neutron/metadata_agent.ini DEFAULT \</span><br><span class="line">  metadata_proxy_shared_secret <span class="number">69</span>e2f4db01fe4100bd32</span><br></pre></td></tr></table></figure>
<h4 id="配置oscontroller上的nova：">配置oscontroller上的nova：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT \</span><br><span class="line">  service_neutron_metadata_proxy <span class="literal">true</span></span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT \</span><br><span class="line">  neutron_metadata_proxy_shared_secret <span class="number">69</span>e2f4db01fe4100bd32</span><br><span class="line">$ service openstack-nova-api restart</span><br></pre></td></tr></table></figure>
<h4 id="配置osnetwork上的ML2,_OVS插件：">配置osnetwork上的ML2, OVS插件：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 \</span><br><span class="line">  <span class="built_in">type</span>_drivers gre</span><br><span class="line">$ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 \</span><br><span class="line">  tenant_network_types gre</span><br><span class="line">$ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 \</span><br><span class="line">  mechanism_drivers openvswitch</span><br><span class="line">$ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2_<span class="built_in">type</span>_gre \</span><br><span class="line">  tunnel_id_ranges <span class="number">1</span>:<span class="number">1000</span></span><br><span class="line">$ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ovs \</span><br><span class="line">  <span class="built_in">local</span>_ip <span class="number">10.0</span>.<span class="number">100.146</span> <span class="comment"># osnetwork的内部ip</span></span><br><span class="line">$ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ovs \</span><br><span class="line">  tunnel_<span class="built_in">type</span> gre</span><br><span class="line">$ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ovs \</span><br><span class="line">  <span class="built_in">enable</span>_tunneling True</span><br><span class="line">$ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini securitygroup \</span><br><span class="line">  firewall_driver neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver</span><br><span class="line">$ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini securitygroup \</span><br><span class="line">  <span class="built_in">enable</span>_security_group True</span><br><span class="line">$ ln <span class="operator">-s</span> plugins/ml2/ml2_conf.ini /etc/neutron/plugin.ini</span><br></pre></td></tr></table></figure>
<p>修复打包的bug，让neutron-openvswitch-agent使用<code>plugin.ini</code>配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cp /etc/init.d/neutron-openvswitch-agent /etc/init.d/neutron-openvswitch-agent.orig</span><br><span class="line">$ sed -i <span class="string">'s,plugins/openvswitch/ovs_neutron_plugin.ini,plugin.ini,g'</span> /etc/init.d/neutron-openvswitch-agent</span><br></pre></td></tr></table></figure>
<h4 id="启动OVS，添加br-int,_br-ex为内部和外部bridge：">启动OVS，添加br-int, br-ex为内部和外部bridge：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ service openvswitch start</span><br><span class="line">$ chkconfig openvswitch on</span><br><span class="line">$ ovs-vsctl add-br br-int</span><br><span class="line">$ ovs-vsctl add-br br-ex</span><br><span class="line">$ ovs-vsctl add-port br-ex eth1</span><br></pre></td></tr></table></figure>
<p>官网提示内部虚拟机和外部网络之间的吞吐可以通过关闭GRO提升，临时关闭方法：<code>ethtool -K INTERFACE_NAME gro off</code></p>
<p>Ops. 发现添加port后网络连接断开了。Google下，Linux bridge kernel module一直要求一旦某个interface加入到了在某个bridge下时，不能再单独配置IP被访问，如果要访问host，则可以把这个IP（或其他可访问的IP）分配给所在的bridge。可以参考<a href="http://www.gossamer-threads.com/lists/openstack/operators/34627" title="Problem configuring openvswitch br-ex" target="_blank" rel="external">这个链接</a>。对应的解决方案就是把原来的public ip从eth1删除，配置到br-exs上：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ip addr del <span class="number">192.168</span>.<span class="number">182.151</span>/<span class="number">25</span> dev eth1</span><br><span class="line">$ ip addr add <span class="number">192.168</span>.<span class="number">182.151</span>/<span class="number">25</span> dev br-ex</span><br><span class="line">$ ip route del default via <span class="number">192.168</span>.<span class="number">182.254</span> dev eth1  <span class="comment"># 改变默认路由</span></span><br><span class="line">$ ip route add default via <span class="number">192.168</span>.<span class="number">182.254</span> dev br-ex</span><br></pre></td></tr></table></figure>
<p>这样就能再次访问osnetwork节点，看<a href="https://www.rdoproject.org/Neutron_with_existing_external_network" title="Neutron_with_existing_external_network" target="_blank" rel="external">RDO的文档</a>里也有提及，建议把br-ex写到配置文件并删除eth1配置文件里的IP信息后重启网络：</p>
<p>新增<code>/etc/sysconfig/network-scripts/ifcfg-br-ex</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DEVICE=br-ex&#10;DEVICETYPE=ovs&#10;TYPE=OVSBridge&#10;BOOTPROTO=static&#10;IPADDR=192.168.182.151&#10;NETMASK=255.255.255.128 # your netmask&#10;GATEWAY=192.168.182.254 # your gateway&#10;#DNS1=192.168.122.1      # your nameserver&#10;ONBOOT=yes</span><br></pre></td></tr></table></figure>
<p>修改<code>/etc/sysconfig/network-scripts/ifcfg-eth1</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DEVICE=eth1&#10;HWADDR=00:50:56:b8:dd:e0 # your hwaddr&#10;TYPE=OVSPort&#10;DEVICETYPE=ovs&#10;OVS_BRIDGE=br-ex&#10;ONBOOT=yes&#10;&#10;#NM_CONTROLLED=yes&#10;#BOOTPROTO=none&#10;#IPADDR=192.168.182.151&#10;#NETMASK=255.255.255.128&#10;#GATEWAY=192.168.182.254&#10;#IPV6INIT=no&#10;#USERCTL=no</span><br></pre></td></tr></table></figure>
<p>修改完之后，执行：<code>service network restart</code>，系统会自动把默认路由指向br-ex。</p>
<h4 id="启动Neutron_Agent服务：">启动Neutron Agent服务：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">for</span> svc <span class="keyword">in</span> neutron-&#123;openvswitch,l3,dhcp,metadata&#125;-agent; <span class="keyword">do</span> \</span><br><span class="line">	service <span class="variable">$svc</span> start; chkconfig <span class="variable">$svc</span> on;<span class="keyword">done</span>;</span><br><span class="line">$ <span class="keyword">for</span> svc <span class="keyword">in</span> neutron-&#123;openvswitch,l3,dhcp,metadata&#125;-agent; <span class="keyword">do</span> \</span><br><span class="line">	service <span class="variable">$svc</span> status; chkconfig | grep  <span class="variable">$svc</span>;<span class="keyword">done</span>;</span><br></pre></td></tr></table></figure>
<h3 id="在oscompute1和oscompute2上配置Linux转发及Neutron_Agent">在oscompute1和oscompute2上配置Linux转发及Neutron Agent</h3><h4 id="启用Linux转发">启用Linux转发</h4><p>编辑<code>/etc/sysctl.conf</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.conf.all.rp_filter=<span class="number">0</span></span><br><span class="line">net.ipv4.conf.default.rp_filter=<span class="number">0</span></span><br><span class="line">net.bridge.bridge-nf-call-arptables=<span class="number">1</span></span><br><span class="line">net.bridge.bridge-nf-call-iptables=<span class="number">1</span></span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>使生效：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sysctl -p</span><br></pre></td></tr></table></figure>
<h4 id="安装部署Neutron_ML2和OVS">安装部署Neutron ML2和OVS</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y openstack-neutron-ml2 openstack-neutron-openvswitch</span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf DEFAULT \</span><br><span class="line">  auth_strategy keystone</span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken \</span><br><span class="line">  auth_uri http://<span class="number">10.0</span>.<span class="number">100.149</span>:<span class="number">5000</span></span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken \</span><br><span class="line">  auth_host <span class="number">10.0</span>.<span class="number">100.149</span></span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken \</span><br><span class="line">  auth_protocol http</span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken \</span><br><span class="line">  auth_port <span class="number">35357</span></span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken \</span><br><span class="line">  admin_tenant_name service</span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken \</span><br><span class="line">  admin_user neutron</span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf keystone_authtoken \</span><br><span class="line">  admin_password <span class="number">033</span>d164bcc70e1244be7</span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf DEFAULT \</span><br><span class="line">  rpc_backend neutron.openstack.common.rpc.impl_qpid</span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf DEFAULT \</span><br><span class="line">  qpid_hostname <span class="number">10.0</span>.<span class="number">100.149</span></span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf DEFAULT \</span><br><span class="line">  core_plugin ml2</span><br><span class="line">$ openstack-config --set /etc/neutron/neutron.conf DEFAULT \</span><br><span class="line">  service_plugins router</span><br></pre></td></tr></table></figure>
<h4 id="配置ML2">配置ML2</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 \</span><br><span class="line">  <span class="built_in">type</span>_drivers gre</span><br><span class="line">$ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 \</span><br><span class="line">  tenant_network_types gre</span><br><span class="line">$ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2 \</span><br><span class="line">  mechanism_drivers openvswitch</span><br><span class="line">$ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ml2_<span class="built_in">type</span>_gre \</span><br><span class="line">  tunnel_id_ranges <span class="number">1</span>:<span class="number">1000</span></span><br><span class="line">$ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ovs \</span><br><span class="line">  <span class="built_in">local</span>_ip <span class="number">10.0</span>.<span class="number">100.147</span>/<span class="number">148</span></span><br><span class="line">$ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ovs \</span><br><span class="line">  tunnel_<span class="built_in">type</span> gre</span><br><span class="line">$ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini ovs \</span><br><span class="line">  <span class="built_in">enable</span>_tunneling True</span><br><span class="line">$ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini securitygroup \</span><br><span class="line">  firewall_driver neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver</span><br><span class="line">$ openstack-config --set /etc/neutron/plugins/ml2/ml2_conf.ini securitygroup \</span><br><span class="line">  <span class="built_in">enable</span>_security_group True</span><br><span class="line">$ ln <span class="operator">-s</span> plugins/ml2/ml2_conf.ini /etc/neutron/plugin.ini</span><br></pre></td></tr></table></figure>
<h4 id="配置OVS">配置OVS</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ service openvswitch start</span><br><span class="line">$ chkconfig openvswitch on</span><br><span class="line">$ ovs-vsctl add-br br-int</span><br></pre></td></tr></table></figure>
<h4 id="配置Nova-Compute">配置Nova-Compute</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT \</span><br><span class="line">  network_api_class nova.network.neutronv2.api.API</span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT \</span><br><span class="line">  neutron_url http://<span class="number">10.0</span>.<span class="number">100.145</span>:<span class="number">9696</span></span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT \</span><br><span class="line">  neutron_auth_strategy keystone</span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT \</span><br><span class="line">  neutron_admin_tenant_name service</span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT \</span><br><span class="line">  neutron_admin_username neutron</span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT \</span><br><span class="line">  neutron_admin_password <span class="number">033</span>d164bcc70e1244be7</span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT \</span><br><span class="line">  neutron_admin_auth_url http://<span class="number">10.0</span>.<span class="number">100.149</span>:<span class="number">35357</span>/v2.<span class="number">0</span></span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT \</span><br><span class="line">  linuxnet_interface_driver nova.network.linux_net.LinuxOVSInterfaceDriver</span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT \</span><br><span class="line">  firewall_driver nova.virt.firewall.NoopFirewallDriver</span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT \</span><br><span class="line">  security_group_api neutron</span><br></pre></td></tr></table></figure>
<h4 id="修改neutron-openvswitch-agent使用plugin-ini配置：">修改<code>neutron-openvswitch-agent</code>使用plugin.ini配置：</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cp /etc/init.d/neutron-openvswitch-agent /etc/init.d/neutron-openvswitch-agent.orig</span><br><span class="line">$ sed -i <span class="string">'s,plugins/openvswitch/ovs_neutron_plugin.ini,plugin.ini,g'</span> /etc/init.d/neutron-openvswitch-agent</span><br></pre></td></tr></table></figure>
<h4 id="启动nova-computer,neutron-openvswitch-agent进程">启动<code>nova-computer</code>,<code>neutron-openvswitch-agent</code>进程</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ service openstack-nova-compute restart</span><br><span class="line">$ service neutron-openvswitch-agent start</span><br><span class="line">$ chkconfig neutron-openvswitch-agent on</span><br></pre></td></tr></table></figure>
<h3 id="初始化虚拟机的网络">初始化虚拟机的网络</h3><p>启动第一个虚拟机实例之前，必须先创建给虚拟机连接的虚拟网络，包括外部网络和租户网络。<br>在oscontroller上，通过admin账户创建外部网络，共享给所有租户；通过demo账户创建租户私有网络，再创建路由实现与外部网络连通。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">source</span> adminrc</span><br><span class="line">$ neutron net-create ext-net --shared --router:external=True</span><br><span class="line">$ neutron subnet-create ext-net --name ext-subnet \</span><br><span class="line">  --allocation-pool start=<span class="number">192.168</span>.<span class="number">182.200</span>,end=<span class="number">192.168</span>.<span class="number">182.220</span> \</span><br><span class="line">  --disable-dhcp --gateway <span class="number">192.168</span>.<span class="number">182.254</span> <span class="number">192.168</span>.<span class="number">182.128</span>/<span class="number">25</span></span><br><span class="line">$ <span class="built_in">source</span> demorc</span><br><span class="line">$ neutron net-create demo-net</span><br><span class="line">$ neutron subnet-create demo-net --name demo-subnet \</span><br><span class="line">  --gateway <span class="number">192.168</span>.<span class="number">1.1</span> <span class="number">192.168</span>.<span class="number">1.0</span>/<span class="number">24</span></span><br><span class="line">$ neutron router-create demo-router</span><br><span class="line">$ neutron router-interface-add demo-router demo-subnet</span><br><span class="line">$ ip netns list <span class="comment"># 能看到新增了一个`qrouter-4bd0dc16-ae05-4304-9483-41c0f9a67775`的namespace</span></span><br><span class="line">$ ip netns <span class="built_in">exec</span> qrouter-<span class="number">4</span>bd0dc16-ae05-<span class="number">4304</span>-<span class="number">9483</span>-<span class="number">41</span>c0f9a67775 ip addr <span class="comment"># 能看到新增了`qr-af814b8f-c9`这个port。</span></span><br><span class="line">$ ovs-vsctl list-ports br-int <span class="comment"># 能看到增加了`qr-af814b8f-c9`这个port。</span></span><br><span class="line">$ neutron router-gateway-set demo-router ext-net</span><br><span class="line">$ ip netns <span class="built_in">exec</span> qrouter-<span class="number">4</span>bd0dc16-ae05-<span class="number">4304</span>-<span class="number">9483</span>-<span class="number">41</span>c0f9a67775 ip addr <span class="comment"># 能看到新增了`qg-269d911c-25`这个port，且它的ip就是ext-subnet里的floating IP。</span></span><br><span class="line">$ ovs-vsctl list-ports br-ex <span class="comment"># 能看到增加了`qg-269d911c-25`这个port。</span></span><br></pre></td></tr></table></figure>
<p>检验连通性，在osnetwork上ping所创建的router（第一个floating IP地址）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ping -c <span class="number">4</span> <span class="number">192.168</span>.<span class="number">182.200</span></span><br><span class="line">$ ip netns <span class="built_in">exec</span> qrouter-<span class="number">4</span>bd0dc16-ae05-<span class="number">4304</span>-<span class="number">9483</span>-<span class="number">41</span>c0f9a67775 ping <span class="number">192.168</span>.<span class="number">182.151</span>  <span class="comment"># 从router发起ping到外部的网络，首先可以ping通所在物理机osnetwork的端口</span></span><br><span class="line">$ ip netns <span class="built_in">exec</span> qrouter-<span class="number">4</span>bd0dc16-ae05-<span class="number">4304</span>-<span class="number">9483</span>-<span class="number">41</span>c0f9a67775 ping <span class="number">192.168</span>.<span class="number">182.100</span> <span class="comment"># 可以ping通网关和其他子网下的Hosts</span></span><br></pre></td></tr></table></figure>
<p>从这里可以理解，底层是通过Linux kernel的net namespace实现了网络隔离，即多租户能力。其实neutron给router添加interface和设定gateway的的时候，其实是在底层创建了一个net namespace并把租户子网的网关和从外部网络获取的floatingIP添加到了router中作为port，从而实现租户内私有网络和外部公共网络打通。</p>
<p>如果发现从router里可以和osnetwork互相ping通，但是无法和同一子网下的其他主机ping通，很大程度上是二层交换问题，可以通过在osnetwork和router上同时抓包，分析arp请求；如果发现arp无返回，则说明二层osnetwork之外的交换机配置有问题，比如在vmware虚拟化环境下安装openstack，则需要把vmware的虚拟交换机开启<code>混杂模式</code>。用到的调测命令如下，更多可以参考<a href="http://docs.openstack.org/openstack-ops/content/network_troubleshooting.html" title="Network troubleshooting" target="_blank" rel="external">网络问题排查方法</a>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ovs-appctl fdb/show br-ex <span class="comment"># 查看br-ex的mac表，可以查看mac地址学习状态</span></span><br><span class="line">$ ip netns <span class="built_in">exec</span> qrouter-<span class="number">4</span>bd0dc16-ae05-<span class="number">4304</span>-<span class="number">9483</span>-<span class="number">41</span>c0f9a67775 tcpdump -nn arp  <span class="comment"># 在router上抓arp包</span></span><br><span class="line">$ ip netns <span class="built_in">exec</span> qrouter-<span class="number">4</span>bd0dc16-ae05-<span class="number">4304</span>-<span class="number">9483</span>-<span class="number">41</span>c0f9a67775 ip route <span class="comment"># 在router上执行路由命令</span></span><br><span class="line">$ ovs-vsctl list Interface gre-<span class="number">0</span>a006491 <span class="comment"># 查看 ovs交换机上某个端口的详细状态</span></span><br><span class="line">$ neutron agent-list <span class="comment"># 查看neutron上网络组件状态</span></span><br><span class="line">$ ovs-dpctl show <span class="comment">#查看ovs端口配置</span></span><br></pre></td></tr></table></figure>
<h3 id="虚拟机网络流量通道">虚拟机网络流量通道</h3><p><img src="http://docs.openstack.org/admin-guide-cloud/content/figures/14/a/a/common/figures/under-the-hood-scenario-1-ovs-compute.png" alt="ovs networking"><br>在创建虚拟机之后（可以部署完dashboard之后做更方便），可以<code>ip addr</code>看到oscomputeX上新增了4个设备，分别以<code>tap, qbr, qvb, qvo</code>开头，osnetwork上也也新增了<code>qdhcp</code>开头的namespace。oscomputeX上新增的tap设备用于连接虚拟机端口，qbr是一个普通linux bridge，qvb和qvo是veth pair，连接了qbr和br-int。不把tap直接挂到br-int的理由就是目前Openstack security group的实现方式是基于iptables对tap设备的控制，而openvswitch不支持iptables控制挂在它上面的tap设备。<br>官方引文如下，详细可以参考<a href="http://docs.openstack.org/admin-guide-cloud/content/under_the_hood_openvswitch.html" title="Networking Openvswitch on Openstack" target="_blank" rel="external">Networking Openvswitch on Openstack</a>:</p>
<blockquote>
<p>Security groups: iptables and Linux bridges<br>Ideally, the TAP device vnet0 would be connected directly to the integration bridge, br-int. Unfortunately, this isn’t possible because of how OpenStack security groups are currently implemented. OpenStack uses iptables rules on the TAP devices such as vnet0 to implement security groups, and Open vSwitch is not compatible with iptables rules that are applied directly on TAP devices that are connected to an Open vSwitch port.<br>Networking uses an extra Linux bridge and a veth pair as a workaround for this issue. Instead of connecting vnet0 to an Open vSwitch bridge, it is connected to a Linux bridge, qbrXXX. This bridge is connected to the integration bridge, br-int, through the (qvbXXX, qvoXXX) veth pair.</p>
</blockquote>
<h3 id="删除或变更GRE通道">删除或变更GRE通道</h3><p>当使用GRE tunnel时，所有network节点和compute节点之间是建立了full-mesh结构的点对点tunnel，当需要变动ip地址的时候（比如之前配置的时候把network节点上的local_ipx写错），需要手动把neutron数据库ip_addressb表中的错误ip删除，修改配置文件后重启network和计算节点傻姑上的<code>neutron-openvswitch-agent</code>服务。</p>
<h2 id="Dashboard">Dashboard</h2><p>Horizon是一个基于python2.6的Django app。需要安装Keystone和Nova服务之后才能使用dashboard。<br>在oskeystone上部署dashboard：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y memcached python-memcached mod_wsgi openstack-dashboard</span><br></pre></td></tr></table></figure>
<p>根据<code>/etc/sysconfig/memcached</code>内容修改<code>/etc/openstack-dashboard/local_settings</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CACHES = &#123;&#10;&#9;&#39;default&#39;: &#123;&#10;&#9;&#39;BACKEND&#39; : &#39;django.core.cache.backends.memcached.MemcachedCache&#39;,&#10;&#9;&#39;LOCATION&#39; : &#39;127.0.0.1:11211&#39;&#10;&#9;&#125;&#10;&#125;&#10;ALLOWED_HOSTS = [&#39;localhost&#39;, &#39;192.168.182.154&#39;]&#10;OPENSTACK_HOST = &#34;10.0.100.149&#34;  # hostname of Identity Service</span><br></pre></td></tr></table></figure>
<p>启动服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ setsebool -P httpd_can_network_connect on</span><br><span class="line">$ getsebool httpd_can_network_connect <span class="comment"># check selinux status</span></span><br><span class="line">$ service httpd start</span><br><span class="line">$ service httpd start</span><br><span class="line">$ chkconfig httpd on</span><br><span class="line">$ chkconfig memcached on</span><br></pre></td></tr></table></figure>
<p>访问<code>http://192.168.182.149/dashboard</code>，Ops…看apache日志<code>tailf /var/log/httpd/error_log</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">...&#10;File &#34;/usr/lib/python2.6/site-packages/keystoneclient/__init__.py&#34;, line 43, in &#60;module&#62;&#10;__version__ = pbr.version.VersionInfo(&#39;python-keystoneclient&#39;).version_string()&#10;...&#10;File &#34;/usr/lib/python2.6/site-packages/pbr/packaging.py&#34;, line 864, in get_version&#10;raise Exception(&#34;Versioning for this project requires either an sdist&#34;&#10;Exception: Versioning for this project requires either an sdist tarball, or access to an upstream git repository. Are you sure that git is installed?&#10;...</span><br></pre></td></tr></table></figure>
<p>看起来跟<code>python-keystoneclient</code>的加载有关，于是关闭apache，用本地命令执行方式启动horizon的Django应用，如果要切换回Apache等启动方式，记得删除<code>/tmp</code>下自动生成的<code>SECRET_KEY</code>（在<code>/etc/openstack-dashboard/local_settings</code>中配置）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /usr/share/openstack-dashboard</span><br><span class="line">$ python manage.py runserver <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>发现错误信息一致，甚至不加参数执行<code>python manage.py</code>也会出现同样错误。Google到<a href="https://github.com/rackspace/pyrax/issues/450" target="_blank" rel="external">一个同样的问题</a>，更新<code>distribute</code>可解决，具体原因还没找到，初步估计跟打包方式及pbr有关：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pip install --upgrade distribute</span><br></pre></td></tr></table></figure>
<p>另，如果出现<code>ERROR: [Errno 113] No route to host</code>，可以检查Nova服务端的Host上iptables是否设置正确。</p>
<h2 id="Block_Service:_Cinder">Block Service: Cinder</h2><ul>
<li><code>cinder-api</code>: API</li>
<li><code>cinder-volume</code>: 通过driver与块设备交互</li>
<li><code>cinder-scheduler</code>: 选择最优块来创建卷</li>
</ul>
<h3 id="在oscontroller上安装Cinder_Service">在oscontroller上安装Cinder Service</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y openstack-cinder</span><br><span class="line">$ openstack-config --set /etc/cinder/cinder.conf \</span><br><span class="line">  database connection mysql://cinder:<span class="number">791</span>ce55fa6888c065bf3@<span class="number">10.0</span>.<span class="number">100.149</span>/cinder</span><br></pre></td></tr></table></figure>
<p>在oskeystone上创建cinder的数据库：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ mysql -u root -pa904019ba8cc0b14bef2</span><br><span class="line">mysql&gt; CREATE DATABASE cinder;</span><br><span class="line">mysql&gt; GRANT ALL PRIVILEGES ON cinder.* TO <span class="string">'cinder'</span>@<span class="string">'%'</span> \</span><br><span class="line">  IDENTIFIED BY <span class="string">'791ce55fa6888c065bf3'</span>;</span><br></pre></td></tr></table></figure>
<p>同步数据库结构：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ su <span class="operator">-s</span> /bin/sh -c <span class="string">"cinder-manage db sync"</span> cinder</span><br></pre></td></tr></table></figure>
<p>创建cinder的keystone账户，配置<code>/etc/cinder/cinder.conf</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ keystone user-create --name=cinder --pass=<span class="number">89</span>edec5c2869dce44c61 --email=cinder@tecstack.org</span><br><span class="line">$ keystone user-role-add --user=cinder --tenant=service --role=admin</span><br><span class="line">$ openstack-config --set /etc/cinder/cinder.conf DEFAULT \</span><br><span class="line">  auth_strategy keystone</span><br><span class="line">$ openstack-config --set /etc/cinder/cinder.conf keystone_authtoken \</span><br><span class="line">  auth_uri http://<span class="number">10.0</span>.<span class="number">100.149</span>:<span class="number">5000</span></span><br><span class="line">$ openstack-config --set /etc/cinder/cinder.conf keystone_authtoken \</span><br><span class="line">  auth_host <span class="number">10.0</span>.<span class="number">100.149</span></span><br><span class="line">$ openstack-config --set /etc/cinder/cinder.conf keystone_authtoken \</span><br><span class="line">  auth_protocol http</span><br><span class="line">$ openstack-config --set /etc/cinder/cinder.conf keystone_authtoken \</span><br><span class="line">  auth_port <span class="number">35357</span></span><br><span class="line">$ openstack-config --set /etc/cinder/cinder.conf keystone_authtoken \</span><br><span class="line">  admin_user cinder</span><br><span class="line">$ openstack-config --set /etc/cinder/cinder.conf keystone_authtoken \</span><br><span class="line">  admin_tenant_name service</span><br><span class="line">$ openstack-config --set /etc/cinder/cinder.conf keystone_authtoken \</span><br><span class="line">  admin_password <span class="number">89</span>edec5c2869dce44c61</span><br></pre></td></tr></table></figure>
<p>配置MQ，在Keystone上注册Cinder Service：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ openstack-config --set /etc/cinder/cinder.conf \</span><br><span class="line">  DEFAULT rpc_backend qpid</span><br><span class="line">$ openstack-config --set /etc/cinder/cinder.conf \</span><br><span class="line">  DEFAULT qpid_hostname <span class="number">10.0</span>.<span class="number">100.149</span></span><br><span class="line"><span class="comment"># API Version 1</span></span><br><span class="line">$ keystone service-create --name=cinder --type=volume --description=<span class="string">"OpenStack Block Storage"</span></span><br><span class="line">$ keystone endpoint-create \</span><br><span class="line">  --service-id=$(keystone service-list | awk <span class="string">'/ volume / &#123;print $2&#125;'</span>) \</span><br><span class="line">  --publicurl=http://<span class="number">192.168</span>.<span class="number">182.150</span>:<span class="number">8776</span>/v1/%\(tenant_id\)s \</span><br><span class="line">  --internalurl=http://<span class="number">10.0</span>.<span class="number">100.145</span>:<span class="number">8776</span>/v1/%\(tenant_id\)s \</span><br><span class="line">  --adminurl=http://<span class="number">10.0</span>.<span class="number">100.145</span>:<span class="number">8776</span>/v1/%\(tenant_id\)s</span><br><span class="line"><span class="comment"># API Version 2</span></span><br><span class="line">$ keystone service-create --name=cinderv2 --type=volumev2 --description=<span class="string">"OpenStack Block Storage v2"</span></span><br><span class="line">$ keystone endpoint-create \</span><br><span class="line">  --service-id=$(keystone service-list | awk <span class="string">'/ volumev2 / &#123;print $2&#125;'</span>) \</span><br><span class="line">  --publicurl=http://<span class="number">192.168</span>.<span class="number">182.150</span>:<span class="number">8776</span>/v2/%\(tenant_id\)s \</span><br><span class="line">  --internalurl=http://<span class="number">10.0</span>.<span class="number">100.145</span>:<span class="number">8776</span>/v2/%\(tenant_id\)s \</span><br><span class="line">  --adminurl=http://<span class="number">10.0</span>.<span class="number">100.145</span>:<span class="number">8776</span>/v2/%\(tenant_id\)s</span><br></pre></td></tr></table></figure>
<p>启动服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ service openstack-cinder-api start</span><br><span class="line">$ service openstack-cinder-scheduler start</span><br><span class="line">$ chkconfig openstack-cinder-api on</span><br><span class="line">$ chkconfig openstack-cinder-scheduler on</span><br></pre></td></tr></table></figure>
<h3 id="在osceph0上部署一个临时存储节点">在osceph0上部署一个临时存储节点</h3><p>安装配置cinder：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y openstack-cinder scsi-target-utils</span><br><span class="line">$ openstack-config --set /etc/cinder/cinder.conf DEFAULT \</span><br><span class="line">  auth_strategy keystone</span><br><span class="line">$ openstack-config --set /etc/cinder/cinder.conf keystone_authtoken \</span><br><span class="line">  auth_uri http://<span class="number">10.0</span>.<span class="number">100.149</span>:<span class="number">5000</span></span><br><span class="line">$ openstack-config --set /etc/cinder/cinder.conf keystone_authtoken \</span><br><span class="line">  auth_host <span class="number">10.0</span>.<span class="number">100.149</span></span><br><span class="line">$ openstack-config --set /etc/cinder/cinder.conf keystone_authtoken \</span><br><span class="line">  auth_protocol http</span><br><span class="line">$ openstack-config --set /etc/cinder/cinder.conf keystone_authtoken \</span><br><span class="line">  auth_port <span class="number">35357</span></span><br><span class="line">$ openstack-config --set /etc/cinder/cinder.conf keystone_authtoken \</span><br><span class="line">  admin_user cinder</span><br><span class="line">$ openstack-config --set /etc/cinder/cinder.conf keystone_authtoken \</span><br><span class="line">  admin_tenant_name service</span><br><span class="line">$ openstack-config --set /etc/cinder/cinder.conf keystone_authtoken \</span><br><span class="line">  admin_password <span class="number">89</span>edec5c2869dce44c61</span><br><span class="line">$ openstack-config --set /etc/cinder/cinder.conf \</span><br><span class="line">  DEFAULT rpc_backend qpid</span><br><span class="line">$ openstack-config --set /etc/cinder/cinder.conf \</span><br><span class="line">  DEFAULT qpid_hostname <span class="number">10.0</span>.<span class="number">100.149</span></span><br><span class="line">$ openstack-config --set /etc/cinder/cinder.conf \</span><br><span class="line">  database connection mysql://cinder:<span class="number">791</span>ce55fa6888c065bf3@<span class="number">10.0</span>.<span class="number">100.149</span>/cinder</span><br><span class="line">$ openstack-config --set /etc/cinder/cinder.conf \</span><br><span class="line">  DEFAULT my_ip <span class="number">10.0</span>.<span class="number">100.142</span></span><br><span class="line">$ openstack-config --set /etc/cinder/cinder.conf \</span><br><span class="line">  DEFAULT glance_host <span class="number">10.0</span>.<span class="number">100.145</span>  <span class="comment"># cinder使用glance images创建可启动卷</span></span><br><span class="line">$ openstack-config --set /etc/cinder/cinder.conf \</span><br><span class="line">  DEFAULT iscsi_helper tgtadm  <span class="comment"># 使用tgtadm iSCSI service</span></span><br></pre></td></tr></table></figure>
<p>配置<code>/etc/tgt/targets.conf</code>，让<code>iSCSI target service</code>发现卷：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include /etc/cinder/volumes/*</span><br></pre></td></tr></table></figure>
<p>模拟块设备:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ dd <span class="keyword">if</span>=/dev/zero of=/opt/volumes/cinderVolumes bs=<span class="number">1</span>M count=<span class="number">10240</span></span><br><span class="line">$ losetup <span class="operator">-f</span> cinderVolumes <span class="comment"># 自动找到一个未使用的loop设备</span></span><br><span class="line">$ losetup <span class="operator">-a</span>  <span class="comment"># 查看映射状态</span></span><br><span class="line">$ pvcreate /dev/loop0 <span class="comment"># Use your own loop device</span></span><br><span class="line">$ vgcreate cinder-volumes /dev/loop0 <span class="comment"># Use your own loop device</span></span><br></pre></td></tr></table></figure>
<p>编辑<code>/etc/lvm/lvm.conf</code>，让LVM不要扫描VM所用的卷：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">devices &#123;&#10;...&#10;filter = [ &#34;a/loop0/&#34;, &#34;r/.*/&#34;] # pvdisplay&#21482;&#33021;&#30475;&#21040;loop0&#30340;&#35774;&#22791;&#10;...&#10;&#125;</span><br></pre></td></tr></table></figure>
<p>启动服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ service openstack-cinder-volume start</span><br><span class="line">$ service tgtd start</span><br><span class="line">$ chkconfig openstack-cinder-volume on</span><br><span class="line">$ chkconfig tgtd on</span><br></pre></td></tr></table></figure>
<p>验证测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">source</span> demorc</span><br><span class="line">$ cinder create --display-name myVolume <span class="number">1</span></span><br><span class="line">$ cinder list <span class="comment"># 如果状态为available则正常</span></span><br></pre></td></tr></table></figure>
<p>之后就可以在dashboard上把卷attach到instance上当块设备使用。</p>
<h2 id="创建Instance云主机">创建Instance云主机</h2><p>基于dashboard的很简单，看GUI操作很明确，基于命令也可以。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">source</span> demorc</span><br><span class="line">$ ssh-keygen -t rsa -P <span class="string">''</span> <span class="operator">-f</span> my.key</span><br><span class="line">$ nova keypair-add --pub-key ./my.key.pub demo-key</span><br><span class="line">$ nova keypair-list</span><br><span class="line">$ nova flavor-list</span><br><span class="line">$ nova image-list</span><br><span class="line">$ nova net-list</span><br><span class="line">$ nova secgroup-list</span><br><span class="line">$ nova boot --flavor m1.tiny --image cirros-<span class="number">0.3</span>.<span class="number">2</span>-x86_64 --nic net-id=b7d34c60-<span class="number">5439</span>-<span class="number">4</span>ec8-<span class="number">9468</span>-<span class="number">8</span>e2406801b98 \</span><br><span class="line">  --security-group default --key-name demo-key demo-instance1</span><br><span class="line">$ nova list</span><br><span class="line">$ nova get-vnc-console demo-instance1 novnc</span><br></pre></td></tr></table></figure>
<h2 id="Object_Service:_Swift">Object Service: Swift</h2><ul>
<li>swift-proxy-server: API，操作metadata, container，提供file和container列表，可以配合memcached提高性能；</li>
<li>swift-account-server: swift账号管理</li>
<li>swift-container-server: 容器管理</li>
<li>swift-object-server: 存储节点，要求支持<code>XATTRS</code>，推荐<code>XFS</code></li>
<li>定时任务进程，用于清理、一致性检验等</li>
</ul>
<h3 id="创建swift账号，在keystone上注册服务：">创建swift账号，在keystone上注册服务：</h3><p>192.168.182.128/25做为public网络，10.0.100.0/24做为数据内部同步网络。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ keystone user-create --name=swift --pass=d8e42c6a28bf6eb08b76 \</span><br><span class="line">  --email=swift@tecstack.org</span><br><span class="line">$ keystone user-role-add --user=swift --tenant=service --role=admin</span><br><span class="line">$ keystone service-create --name=swift --type=object-store \</span><br><span class="line">  --description=<span class="string">"OpenStack Object Storage"</span></span><br><span class="line">$ keystone endpoint-create \</span><br><span class="line">  --service-id=$(keystone service-list | awk <span class="string">'/ object-store / &#123;print $2&#125;'</span>) \</span><br><span class="line">  --publicurl=<span class="string">'http://192.168.182.144:8080/v1/AUTH_%(tenant_id)s'</span> \</span><br><span class="line">  --internalurl=<span class="string">'http://10.0.100.139:8080/v1/AUTH_%(tenant_id)s'</span> \</span><br><span class="line">  --adminurl=http://<span class="number">10.0</span>.<span class="number">100.139</span>:<span class="number">8080</span></span><br></pre></td></tr></table></figure>
<p>在<strong>所有节点</strong>上配置swift hash，用于确定swift ring的mapping，所有节点要一致且不可更改:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p /etc/swift</span><br><span class="line">$ openssl rand -base64 <span class="number">12</span> <span class="comment"># 执行2次，生成2个随机字符串，用于swift_hash_path_*fix</span></span><br><span class="line">$ cat &gt; /etc/swift/swift.conf &lt;&lt; EOF</span><br><span class="line">[swift-hash]</span><br><span class="line"><span class="comment"># random unique string that can never change (DO NOT LOSE)</span></span><br><span class="line">swift_<span class="built_in">hash</span>_path_prefix = Fjt8GhQTi13Vr6Hc</span><br><span class="line">swift_<span class="built_in">hash</span>_path_suffix = <span class="number">7</span>uOcSBwQrK6pAtfx</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h3 id="部署存储节点">部署存储节点</h3><p>每个osswift节点创建3个模拟的块设备，每个设备分配5G容量，在所有osswift上操作：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p /opt/swift_disk</span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/zero of=/opt/swift_disk/swdisk0 bs=<span class="number">1</span>M count=<span class="number">5120</span></span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/zero of=/opt/swift_disk/swdisk1 bs=<span class="number">1</span>M count=<span class="number">5120</span></span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/zero of=/opt/swift_disk/swdisk2 bs=<span class="number">1</span>M count=<span class="number">5120</span></span><br><span class="line">$ losetup <span class="operator">-f</span> /opt/swift_disk/swdisk0</span><br><span class="line">$ losetup <span class="operator">-f</span> /opt/swift_disk/swdisk1</span><br><span class="line">$ losetup <span class="operator">-f</span> /opt/swift_disk/swdisk2</span><br><span class="line">$ losetup <span class="operator">-a</span> <span class="comment"># 查看映射状态</span></span><br></pre></td></tr></table></figure>
<p>安装部署：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y openstack-swift-account openstack-swift-container \</span><br><span class="line">  openstack-swift-object xfsprogs xinetd</span><br><span class="line">$ <span class="keyword">for</span> i <span class="keyword">in</span> loop&#123;<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>&#125;;<span class="keyword">do</span> mkfs.xfs /dev/<span class="variable">$i</span>; <span class="built_in">echo</span> <span class="string">"/dev/<span class="variable">$i</span> /srv/node/<span class="variable">$i</span> xfs noatime,nodiratime,nobarrier,logbufs=8 0 0"</span> &gt;&gt; /etc/fstab; mkdir -p /srv/node/<span class="variable">$i</span> ; mount /srv/node/<span class="variable">$i</span>;<span class="keyword">done</span>;</span><br><span class="line">$ chown -R swift:swift /srv/node  <span class="comment"># 注意每次重建xfs之后需要确认权限</span></span><br></pre></td></tr></table></figure>
<p>创建<code>/etc/rsyncd.conf</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uid = swift&#10;gid = swift&#10;log file = /var/log/rsyncd.log&#10;pid file = /var/run/rsyncd.pid&#10;address = 10.0.100.139/140/141 # &#21508;&#20010;&#23384;&#20648;&#33410;&#28857;&#30340;&#25968;&#25454;&#21516;&#27493;&#32593;IP&#10; &#10;[account]&#10;max connections = 2&#10;path = /srv/node/&#10;read only = false&#10;lock file = /var/lock/account.lock&#10; &#10;[container]&#10;max connections = 2&#10;path = /srv/node/&#10;read only = false&#10;lock file = /var/lock/container.lock&#10; &#10;[object]&#10;max connections = 2&#10;path = /srv/node/&#10;read only = false&#10;lock file = /var/lock/object.lock</span><br></pre></td></tr></table></figure>
<p>配置<code>/etc/xinetd.d/rsync</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">disable = no</span><br></pre></td></tr></table></figure>
<p>启动xinetd:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ service xinetd start</span><br><span class="line">$ mkdir -p /var/swift/recon</span><br><span class="line">$ chown -R swift:swift /var/swift/recon</span><br></pre></td></tr></table></figure>
<p>配置<code>/etc/swift/account-server.conf</code>,<code>/etc/swift/container-server.conf</code>,<code>/etc/swift/object-server.conf</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">...&#10;bind_ip = 192.168.182.144/145/146 # &#32465;&#23450;&#21040;&#21508;&#33258;&#33410;&#28857;&#30340;public&#32593;&#32476;&#22320;&#22336;&#10;...</span><br></pre></td></tr></table></figure>
<h3 id="在osswift0上部署proxy_server">在osswift0上部署proxy server</h3><p>使用oskeystone上的memcached：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y openstack-swift-proxy python-swiftclient python-keystone-auth-token</span><br></pre></td></tr></table></figure>
<p>配置<code>/etc/swift/proxy-server.conf</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">[filter:authtoken]</span><br><span class="line">paste.filter_factory = keystoneclient.middleware.auth_token:filter_factory</span><br><span class="line"><span class="comment"># Delaying the auth decision is required to support token-less</span></span><br><span class="line"><span class="comment"># usage for anonymous referrers ('.r:*').</span></span><br><span class="line">delay_auth_decision = <span class="literal">true</span></span><br><span class="line">auth_protocol = http</span><br><span class="line">auth_host = <span class="number">10.0</span>.<span class="number">100.149</span></span><br><span class="line">auth_port = <span class="number">35357</span></span><br><span class="line">admin_tenant_name = service</span><br><span class="line">admin_user = swift</span><br><span class="line">admin_password = d8e42c6a28bf6eb08b76</span><br><span class="line"></span><br><span class="line">[filter:cache]</span><br><span class="line">use = egg:swift	<span class="comment">#memcache</span></span><br><span class="line"><span class="number">10.0</span>.<span class="number">100.149</span>:<span class="number">11211</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>配置<code>/etc/swift/object-expirer.conf</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">...&#10;[filter:cache]&#10;use = egg:swift#memcache&#10;memcache_servers = 10.0.100.149:11211&#10;...</span><br></pre></td></tr></table></figure>
<p>配置swift的ring：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /etc/swift</span><br><span class="line">$ swift-ring-builder account.builder create <span class="number">18</span> <span class="number">3</span> <span class="number">1</span></span><br><span class="line">$ swift-ring-builder container.builder create <span class="number">18</span> <span class="number">3</span> <span class="number">1</span></span><br><span class="line">$ swift-ring-builder object.builder create <span class="number">18</span> <span class="number">3</span> <span class="number">1</span></span><br><span class="line">$ <span class="keyword">for</span> i <span class="keyword">in</span> loop&#123;<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>&#125;; <span class="keyword">do</span> swift-ring-builder account.builder add z1-<span class="number">192.168</span>.<span class="number">182.144</span>:<span class="number">6002</span>R10.<span class="number">0.100</span>.<span class="number">139</span>:<span class="number">6005</span>/<span class="variable">$i</span> <span class="number">100</span>; swift-ring-builder container.builder add z1-<span class="number">192.168</span>.<span class="number">182.144</span>:<span class="number">6001</span>R10.<span class="number">0.100</span>.<span class="number">139</span>:<span class="number">6004</span>/<span class="variable">$i</span> <span class="number">100</span>; swift-ring-builder object.builder add z1-<span class="number">192.168</span>.<span class="number">182.144</span>:<span class="number">6000</span>R10.<span class="number">0.100</span>.<span class="number">139</span>:<span class="number">6003</span>/<span class="variable">$i</span> <span class="number">100</span>; <span class="keyword">done</span>; <span class="comment"># 把osswift0的设备加入zone1</span></span><br><span class="line">$ <span class="keyword">for</span> i <span class="keyword">in</span> loop&#123;<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>&#125;; <span class="keyword">do</span> swift-ring-builder account.builder add z2-<span class="number">192.168</span>.<span class="number">182.145</span>:<span class="number">6002</span>R10.<span class="number">0.100</span>.<span class="number">140</span>:<span class="number">6005</span>/<span class="variable">$i</span> <span class="number">100</span>; swift-ring-builder container.builder add z2-<span class="number">192.168</span>.<span class="number">182.145</span>:<span class="number">6001</span>R10.<span class="number">0.100</span>.<span class="number">140</span>:<span class="number">6004</span>/<span class="variable">$i</span> <span class="number">100</span>; swift-ring-builder object.builder add z2-<span class="number">192.168</span>.<span class="number">182.145</span>:<span class="number">6000</span>R10.<span class="number">0.100</span>.<span class="number">140</span>:<span class="number">6003</span>/<span class="variable">$i</span> <span class="number">100</span>; <span class="keyword">done</span>; <span class="comment"># 把osswift1的设备加入zone2</span></span><br><span class="line">$ <span class="keyword">for</span> i <span class="keyword">in</span> loop&#123;<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>&#125;; <span class="keyword">do</span> swift-ring-builder account.builder add z3-<span class="number">192.168</span>.<span class="number">182.146</span>:<span class="number">6002</span>R10.<span class="number">0.100</span>.<span class="number">141</span>:<span class="number">6005</span>/<span class="variable">$i</span> <span class="number">100</span>; swift-ring-builder container.builder add z3-<span class="number">192.168</span>.<span class="number">182.146</span>:<span class="number">6001</span>R10.<span class="number">0.100</span>.<span class="number">141</span>:<span class="number">6004</span>/<span class="variable">$i</span> <span class="number">100</span>; swift-ring-builder object.builder add z3-<span class="number">192.168</span>.<span class="number">182.146</span>:<span class="number">6000</span>R10.<span class="number">0.100</span>.<span class="number">141</span>:<span class="number">6003</span>/<span class="variable">$i</span> <span class="number">100</span>; <span class="keyword">done</span>; <span class="comment"># 把osswift2的设备加入zone3</span></span><br><span class="line">$ swift-ring-builder account.builder  <span class="comment"># 注意检查上面的IP, 端口信息</span></span><br><span class="line">$ swift-ring-builder container.builder</span><br><span class="line">$ swift-ring-builder object.builder <span class="comment"># 检查</span></span><br><span class="line">$ swift-ring-builder account.builder rebalance</span><br><span class="line">$ swift-ring-builder container.builder rebalance</span><br><span class="line">$ swift-ring-builder object.builder rebalance <span class="comment"># Relance the ring.</span></span><br><span class="line">$ chown -R swift:swift /etc/swift</span><br></pre></td></tr></table></figure>
<p>把<code>account.ring.gz</code>,<code>container.ring.gz</code>,<code>object.ring.gz</code>复制到proxy-server和Storage Server的<code>/etc/swift</code>下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /etc/swift <span class="comment"># 由于proxy server部署在osswift0，在osswift0上生成ring配置文件。</span></span><br><span class="line">$ scp account.ring.gz container.ring.gz  object.ring.gz root@osswift1:/etc/swift/</span><br><span class="line">$ scp account.ring.gz container.ring.gz  object.ring.gz root@osswift2:/etc/swift/</span><br></pre></td></tr></table></figure>
<h3 id="启动服务：">启动服务：</h3><p>启动proxy节点上的服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ service openstack-swift-proxy start</span><br><span class="line">$ chkconfig openstack-swift-proxy on</span><br></pre></td></tr></table></figure>
<p>启动存储节点上的服务：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ for service in \&#10;  openstack-swift-object openstack-swift-object-replicator openstack-swift-object-updater openstack-swift-object-auditor \&#10;  openstack-swift-container openstack-swift-container-replicator openstack-swift-container-updater openstack-swift-container-auditor \&#10;  openstack-swift-account openstack-swift-account-replicator openstack-swift-account-reaper openstack-swift-account-auditor; do \&#10;    service $service start; chkconfig $service on; done # &#20063;&#21487;&#20197;&#29992;swift-init all start&#21551;&#21160;&#25152;&#26377;&#26381;&#21153;&#36827;&#31243;</span><br></pre></td></tr></table></figure>
<p>检验效果：（确保osswift各个节点的iptables配置正确）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">source</span> adminrc</span><br><span class="line">$ swift <span class="built_in">stat</span></span><br><span class="line">$ <span class="built_in">cd</span>; <span class="built_in">echo</span> <span class="string">"Hello test"</span> &gt; test.txt; <span class="built_in">echo</span> <span class="string">"Hello test2"</span> &gt; <span class="built_in">test</span>2.txt</span><br><span class="line">$ swift upload myfiles test.txt</span><br><span class="line">$ swift upload myfiles <span class="built_in">test</span>2.txt</span><br><span class="line">$ swift download myfiles</span><br></pre></td></tr></table></figure>
<p>swift默认的log比较奇怪，是在/var/log/messages里。</p>
<h2 id="Heat">Heat</h2><p>流程编排服务，类似于vagrant，适合自动化系统规划部署：</p>
<ul>
<li>heat: client</li>
<li>heat-api: REST API</li>
<li>heat-api-cfn: AWS Query API</li>
<li>heat-engine: 根据模板执行</li>
</ul>
<p>在oskeystone上准备heat的数据库：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ mysql -u root -pa904019ba8cc0b14bef2</span><br><span class="line">mysql&gt; CREATE DATABASE heat;</span><br><span class="line">mysql&gt; GRANT ALL PRIVILEGES ON heat.* TO <span class="string">'heat'</span>@<span class="string">'%'</span> \</span><br><span class="line">IDENTIFIED BY <span class="string">'51eb27f53983633f3337'</span>;</span><br></pre></td></tr></table></figure>
<p>在oscontroller上安装heat：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y openstack-heat-api openstack-heat-engine \</span><br><span class="line">  openstack-heat-api-cfn</span><br><span class="line">$ openstack-config --set /etc/heat/heat.conf \</span><br><span class="line">  database connection mysql://heat:<span class="number">51</span>eb27f53983633f3337@<span class="number">10.0</span>.<span class="number">100.149</span>/heat</span><br><span class="line">$ openstack-config --set /etc/heat/heat.conf DEFAULT qpid_hostname <span class="number">10.0</span>.<span class="number">100.149</span></span><br><span class="line">$ openstack-config --set /etc/heat/heat.conf keystone_authtoken \</span><br><span class="line">  auth_uri http://<span class="number">10.0</span>.<span class="number">100.149</span>:<span class="number">5000</span>/v2.<span class="number">0</span></span><br><span class="line">$ openstack-config --set /etc/heat/heat.conf keystone_authtoken \</span><br><span class="line">  auth_host <span class="number">10.0</span>.<span class="number">100.149</span>  <span class="comment"># 官方</span></span><br><span class="line">$ openstack-config --set /etc/heat/heat.conf keystone_authtoken \</span><br><span class="line">  auth_port <span class="number">35357</span></span><br><span class="line">$ openstack-config --set /etc/heat/heat.conf keystone_authtoken \</span><br><span class="line">  auth_protocol http</span><br><span class="line">$ openstack-config --set /etc/heat/heat.conf keystone_authtoken \</span><br><span class="line">  admin_tenant_name service</span><br><span class="line">$ openstack-config --set /etc/heat/heat.conf keystone_authtoken \</span><br><span class="line">  admin_user heat</span><br><span class="line">$ openstack-config --set /etc/heat/heat.conf keystone_authtoken \</span><br><span class="line">  admin_password <span class="number">3817</span>bfface1b24918d4b</span><br><span class="line">$ openstack-config --set /etc/heat/heat.conf ec2authtoken \</span><br><span class="line">  auth_uri http://<span class="number">10.0</span>.<span class="number">100.149</span>:<span class="number">5000</span>/v2.<span class="number">0</span>  <span class="comment"># 可以暂时不配置。</span></span><br><span class="line">$ su <span class="operator">-s</span> /bin/sh -c <span class="string">"heat-manage db_sync"</span> heat</span><br></pre></td></tr></table></figure>
<p>创建Heat Service的keystone账号，注册服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ keystone user-create --name=heat --pass=<span class="number">3817</span>bfface1b24918d4b \</span><br><span class="line">  --email=heat@tecstack.org</span><br><span class="line">$ keystone user-role-add --user=heat --tenant=service --role=admin</span><br><span class="line">$ keystone service-create --name=heat --type=orchestration \</span><br><span class="line">  --description=<span class="string">"Orchestration"</span></span><br><span class="line">$ keystone endpoint-create \</span><br><span class="line">  --service-id=$(keystone service-list | awk <span class="string">'/ orchestration / &#123;print $2&#125;'</span>) \</span><br><span class="line">  --publicurl=http://<span class="number">192.168</span>.<span class="number">182.150</span>:<span class="number">8004</span>/v1/%\(tenant_id\)s \</span><br><span class="line">  --internalurl=http://<span class="number">10.0</span>.<span class="number">100.145</span>:<span class="number">8004</span>/v1/%\(tenant_id\)s \</span><br><span class="line">  --adminurl=http://<span class="number">10.0</span>.<span class="number">100.145</span>:<span class="number">8004</span>/v1/%\(tenant_id\)s</span><br><span class="line">$ keystone service-create --name=heat-cfn --type=cloudformation \</span><br><span class="line">  --description=<span class="string">"Orchestration CloudFormation"</span></span><br><span class="line">$ keystone endpoint-create \</span><br><span class="line">  --service-id=$(keystone service-list | awk <span class="string">'/ cloudformation / &#123;print $2&#125;'</span>) \</span><br><span class="line">  --publicurl=http://<span class="number">192.168</span>.<span class="number">182.150</span>:<span class="number">8000</span>/v1 \</span><br><span class="line">  --internalurl=http://<span class="number">10.0</span>.<span class="number">100.145</span>:<span class="number">8000</span>/v1 \</span><br><span class="line">  --adminurl=http://<span class="number">10.0</span>.<span class="number">100.145</span>:<span class="number">8000</span>/v1</span><br><span class="line">$ keystone role-create --name heat_stack_user <span class="comment"># Orchestration创建用户的默认角色</span></span><br><span class="line">$ openstack-config --set /etc/heat/heat.conf \</span><br><span class="line">  DEFAULT heat_metadata_server_url http://<span class="number">10.0</span>.<span class="number">100.145</span>:<span class="number">8000</span></span><br><span class="line">$ openstack-config --set /etc/heat/heat.conf DEFAULT \ 	heat_waitcondition_server_url http://<span class="number">10.0</span>.<span class="number">100.145</span>:<span class="number">8000</span>/v1/waitcondition</span><br></pre></td></tr></table></figure>
<p>启动服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ service openstack-heat-api start</span><br><span class="line">$ service openstack-heat-api-cfn start</span><br><span class="line">$ service openstack-heat-engine start</span><br><span class="line">$ chkconfig openstack-heat-api on</span><br><span class="line">$ chkconfig openstack-heat-api-cfn on</span><br><span class="line">$ chkconfig openstack-heat-engine on</span><br></pre></td></tr></table></figure>
<p>验证效果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">source</span> demorc</span><br><span class="line">$ vim <span class="built_in">test</span>-stack.yml</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">heat_template_version: 2013-05-23&#10;&#10;description: Test Template&#10;&#10;parameters:&#10;  ImageID:&#10;    type: string&#10;    description: Image use to boot a server&#10;  NetID:&#10;    type: string&#10;    description: Network ID for the server&#10;&#10;resources:&#10;  server1:&#10;    type: OS::Nova::Server&#10;    properties:&#10;      name: &#34;Test server&#34;&#10;      image: &#123; get_param: ImageID &#125;&#10;      flavor: &#34;m1.tiny&#34;&#10;      networks:&#10;      - network: &#123; get_param: NetID &#125;&#10;&#10;outputs:&#10;  server1_private_ip:&#10;    description: IP address of the server in the private network&#10;    value: &#123; get_attr: [ server1, first_address ] &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ NET_ID=$(nova net-list | awk <span class="string">'/ demo-net / &#123; print $2 &#125;'</span>)</span><br><span class="line">$ heat stack-create <span class="operator">-f</span> <span class="built_in">test</span>-stack.yml \</span><br><span class="line">  -P <span class="string">"ImageID=cirros-0.3.2-x86_64;NetID=<span class="variable">$NET_ID</span>"</span> <span class="built_in">test</span>Stack</span><br><span class="line">$ heat stack-list</span><br></pre></td></tr></table></figure>
<h2 id="Ceilometer">Ceilometer</h2><p>监控CPU、网络等指标，通过REST API访问。</p>
<ul>
<li>ceilometer-agent-compute: 部署在每个计算节点，目前主要针对计算节点采集信息；</li>
<li>ceilometer-agent-central: 非计算节点信息采集；</li>
<li>ceilometer-collector: 采集信息汇聚。</li>
<li>ceilometer-alarm-notifier: 告警设置。</li>
<li>ceilometer-api: 接受查询请求。</li>
<li>后端存储，比如mongodb。</li>
</ul>
<h3 id="在osmeter部署Ceilmeter_Service：">在osmeter部署Ceilmeter Service：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y openstack-ceilometer-api openstack-ceilometer-collector \</span><br><span class="line">  openstack-ceilometer-notification openstack-ceilometer-central openstack-ceilometer-alarm python-ceilometerclient</span><br></pre></td></tr></table></figure>
<p>配置MongoDB：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y mongodb-server mongodb</span><br><span class="line">$ vim /etc/mongodb.conf <span class="comment"># edit the bind_ip to osmeter internal ip:10.0.100.150</span></span><br><span class="line">$ service mongod start</span><br><span class="line">$ chkconfig mongod on</span><br><span class="line">$ mongo --host <span class="number">10.0</span>.<span class="number">100.150</span> --eval <span class="string">'</span><br><span class="line">db = db.getSiblingDB("ceilometer");</span><br><span class="line">db.addUser(&#123;user: "ceilometer",</span><br><span class="line">            pwd: "072aac393486f9b29235",</span><br><span class="line">            roles: [ "readWrite", "dbAdmin" ]&#125;)'</span></span><br></pre></td></tr></table></figure>
<p>配置Ceilmeter服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ openstack-config --set /etc/ceilometer/ceilometer.conf \</span><br><span class="line">  database connection mongodb://ceilometer:<span class="number">072</span>aac393486f9b29235@<span class="number">10.0</span>.<span class="number">100.150</span>:<span class="number">27017</span>/ceilometer</span><br><span class="line">$ CEILOMETER_TOKEN=$(openssl rand -hex <span class="number">10</span>)</span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$CEILOMETER_TOKEN</span></span><br><span class="line">$ openstack-config --set /etc/ceilometer/ceilometer.conf publisher metering_secret <span class="variable">$CEILOMETER_TOKEN</span></span><br><span class="line">$ openstack-config --set /etc/ceilometer/ceilometer.conf \</span><br><span class="line">  DEFAULT rpc_backend ceilometer.openstack.common.rpc.impl_qpid</span><br><span class="line">$ openstack-config --set /etc/ceilometer/ceilometer.conf DEFAULT qpid_hostname <span class="number">10.0</span>.<span class="number">100.149</span></span><br><span class="line">$ openstack-config --set /etc/ceilometer/ceilometer.conf \</span><br><span class="line">  DEFAULT auth_strategy keystone</span><br><span class="line">$ openstack-config --set /etc/ceilometer/ceilometer.conf \</span><br><span class="line">  keystone_authtoken auth_host <span class="number">10.0</span>.<span class="number">100.149</span></span><br><span class="line">$ openstack-config --set /etc/ceilometer/ceilometer.conf \</span><br><span class="line">  keystone_authtoken admin_user ceilometer</span><br><span class="line">$ openstack-config --set /etc/ceilometer/ceilometer.conf \</span><br><span class="line">  keystone_authtoken admin_tenant_name service</span><br><span class="line">$ openstack-config --set /etc/ceilometer/ceilometer.conf \</span><br><span class="line">  keystone_authtoken auth_protocol http</span><br><span class="line">$ openstack-config --set /etc/ceilometer/ceilometer.conf \</span><br><span class="line">  keystone_authtoken auth_uri http://<span class="number">10.0</span>.<span class="number">100.149</span>:<span class="number">5000</span></span><br><span class="line">$ openstack-config --set /etc/ceilometer/ceilometer.conf \</span><br><span class="line">  keystone_authtoken admin_password eb8ed86ef2178168c458</span><br><span class="line">$ openstack-config --set /etc/ceilometer/ceilometer.conf \</span><br><span class="line">  service_credentials os_auth_url http://<span class="number">10.0</span>.<span class="number">100.149</span>:<span class="number">5000</span>/v2.<span class="number">0</span></span><br><span class="line">$ openstack-config --set /etc/ceilometer/ceilometer.conf \</span><br><span class="line">  service_credentials os_username ceilometer</span><br><span class="line">$ openstack-config --set /etc/ceilometer/ceilometer.conf \</span><br><span class="line">  service_credentials os_tenant_name service</span><br><span class="line">$ openstack-config --set /etc/ceilometer/ceilometer.conf \</span><br><span class="line">  service_credentials os_password eb8ed86ef2178168c458</span><br></pre></td></tr></table></figure>
<p>注册Keystone服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ keystone service-create --name=ceilometer --type=metering \</span><br><span class="line">  --description=<span class="string">"Telemetry"</span></span><br><span class="line">$ keystone endpoint-create \</span><br><span class="line">  --service-id=$(keystone service-list | awk <span class="string">'/ metering / &#123;print $2&#125;'</span>) \</span><br><span class="line">  --publicurl=http://<span class="number">192.168</span>.<span class="number">182.155</span>:<span class="number">8777</span> \</span><br><span class="line">  --internalurl=http://<span class="number">10.0</span>.<span class="number">100.150</span>:<span class="number">8777</span> \</span><br><span class="line">  --adminurl=http://<span class="number">10.0</span>.<span class="number">100.150</span>:<span class="number">8777</span></span><br><span class="line">$ keystone user-create --name=ceilometer --pass=eb8ed86ef2178168c458 --email=ceilometer@tecstack.org</span><br><span class="line">$ keystone user-role-add --user=ceilometer --tenant=service --role=admin</span><br></pre></td></tr></table></figure>
<p>启动服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">for</span> svc <span class="keyword">in</span> openstack-ceilometer-&#123;api,notification,central,collector,alarm-evaluator,alarm-notifier&#125;; <span class="keyword">do</span> service <span class="variable">$svc</span> start; chkconfig <span class="variable">$svc</span> on; <span class="keyword">done</span>;</span><br></pre></td></tr></table></figure>
<h3 id="给计算节点部署Agent：">给计算节点部署Agent：</h3><p>在oscompute1和oscompute2上安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y openstack-ceilometer-compute python-ceilometerclient python-pecan</span><br><span class="line">$</span><br></pre></td></tr></table></figure>
<p>编辑<code>/etc/nova/nova.conf</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT \</span><br><span class="line">  instance_usage_audit True</span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT \</span><br><span class="line">  instance_usage_audit_period hour</span><br><span class="line">$ openstack-config --set /etc/nova/nova.conf DEFAULT \</span><br><span class="line">  notify_on_state_change vm_and_task_state</span><br></pre></td></tr></table></figure>
<p>多值的参数，直接修改文件如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[DEFAULT]&#10;...&#10;notification_driver = nova.openstack.common.notifier.rpc_notifier&#10;notification_driver = ceilometer.compute.nova_notifier&#10;... # qpid &#21644;qpid_hostname&#20043;&#21069;&#24050;&#32463;&#37197;&#32622;&#36807;&#65292;&#36825;&#37324;&#37319;&#29992;&#19968;&#26679;</span><br></pre></td></tr></table></figure>
<p>编辑<code>/etc/ceilometer/ceilometer.conf</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ openstack-config --set /etc/ceilometer/ceilometer.conf publisher \</span><br><span class="line">  metering_secret <span class="number">711</span>e1a83f278a83de1f8 <span class="comment"># 在ceilometer上用openssl生成的</span></span><br><span class="line">$ openstack-config --set /etc/ceilometer/ceilometer.conf DEFAULT rpc_backend ceilometer.openstack.common.rpc.impl_qpid</span><br><span class="line"><span class="comment"># openstack-config --set /etc/ceilometer/ceilometer.conf DEFAULT qpid_hostname 10.0.100.149</span></span><br><span class="line">$ openstack-config --set /etc/ceilometer/ceilometer.conf \</span><br><span class="line">  keystone_authtoken auth_host <span class="number">10.0</span>.<span class="number">100.149</span></span><br><span class="line">$ openstack-config --set /etc/ceilometer/ceilometer.conf \</span><br><span class="line">  keystone_authtoken admin_user ceilometer</span><br><span class="line">$ openstack-config --set /etc/ceilometer/ceilometer.conf \</span><br><span class="line">  keystone_authtoken admin_tenant_name service</span><br><span class="line">$ openstack-config --set /etc/ceilometer/ceilometer.conf \</span><br><span class="line">  keystone_authtoken auth_protocol http</span><br><span class="line">$ openstack-config --set /etc/ceilometer/ceilometer.conf \</span><br><span class="line">  keystone_authtoken admin_password eb8ed86ef2178168c458</span><br><span class="line">$ openstack-config --set /etc/ceilometer/ceilometer.conf \</span><br><span class="line">  service_credentials os_username ceilometer</span><br><span class="line">$ openstack-config --set /etc/ceilometer/ceilometer.conf \</span><br><span class="line">  service_credentials os_tenant_name service</span><br><span class="line">$ openstack-config --set /etc/ceilometer/ceilometer.conf \</span><br><span class="line">  service_credentials os_password eb8ed86ef2178168c458</span><br><span class="line">$ openstack-config --set /etc/ceilometer/ceilometer.conf \</span><br><span class="line">  service_credentials os_auth_url http://<span class="number">10.0</span>.<span class="number">100.149</span>:<span class="number">5000</span>/v2.<span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>重启服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ service openstack-nova-compute restart</span><br><span class="line">$ service openstack-ceilometer-compute start</span><br><span class="line">$ chkconfig openstack-ceilometer-compute on</span><br></pre></td></tr></table></figure>
<h3 id="给Glance、Cinder、Swift部署Agent：">给Glance、Cinder、Swift部署Agent：</h3><p>在oscontroller上编辑<code>/etc/glance/glance-api.conf</code>，并重启服务:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ openstack-config --set /etc/glance/glance-api.conf DEFAULT notification_driver messaging</span><br><span class="line">$ openstack-config --set /etc/glance/glance-api.conf DEFAULT rpc_backend qpid</span><br><span class="line">$ openstack-config --set /etc/glance/glance-api.conf DEFAULT qpid_hostname <span class="number">10.0</span>.<span class="number">100.149</span></span><br><span class="line">$ service openstack-glance-api restart</span><br><span class="line">$ service openstack-glance-registry restart</span><br></pre></td></tr></table></figure>
<p>在oscontroller和osceph0上编辑<code>/etc/cinder/cinder.conf</code>，并重启服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ openstack-config --set /etc/cinder/cinder.conf DEFAULT control_exchange cinder</span><br><span class="line">$ openstack-config --set /etc/cinder/cinder.conf DEFAULT notification_driver cinder.openstack.common.notifier.rpc_notifier</span><br><span class="line">$ service openstack-cinder-api restart <span class="comment"># 在oscontoller上</span></span><br><span class="line">$ service openstack-cinder-scheduler restart <span class="comment"># 在oscontroller上</span></span><br><span class="line">$ service openstack-cinder-volume restart <span class="comment"># 在osceph0上</span></span><br></pre></td></tr></table></figure>
<p>在osswift0上安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y python-ceilometer</span><br></pre></td></tr></table></figure>
<p>另，ceilometer需要<code>ResellerAdmin</code>角色来获取数据：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ keystone role-create --name=ResellerAdmin</span><br><span class="line">$ keystone user-role-add --tenant service --user ceilometer \</span><br><span class="line">      --role $(keystone role-list | awk <span class="string">'/ ResellerAdmin / &#123;print $2&#125;'</span>)</span><br></pre></td></tr></table></figure>
<p>在osswift0上修改<code>/etc/swift/proxy-server.conf</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">...&#10;[filter:ceilometer]&#10;use = egg:ceilometer#swift&#10;...&#10;[pipeline:main]&#10;pipeline = healthcheck cache authtoken keystoneauth ceilometer proxy-server&#10;...</span><br></pre></td></tr></table></figure>
<p>重启<code>openstack-swift-proxy</code>服务:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ service openstack-swift-proxy restart</span><br></pre></td></tr></table></figure>
<h3 id="检验ceilometer效果">检验ceilometer效果</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ceilometer meter-list</span><br><span class="line">$ glance image-download <span class="string">"cirros-0.3.2-x86_64"</span> &gt; cirros.img <span class="comment"># 下载一个镜像</span></span><br><span class="line">$ ceilometer meter-list</span><br><span class="line">$ ceilometer statistics -m image.download -p <span class="number">60</span></span><br></pre></td></tr></table></figure>
<p>如果遇到采集指标不齐问题，可以检查MQ上的消息队列，可以用<code>qpid-tools</code>工具（其他MQ对应也有其他工具）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y qpid-tools</span><br><span class="line">$ qpid-tool <span class="number">10.0</span>.<span class="number">100.149</span></span><br><span class="line">qpid &gt; list</span><br><span class="line">qpid &gt; list queue/exchange</span><br><span class="line">qpid &gt; show ID_xxx</span><br></pre></td></tr></table></figure>
<h2 id="总结">总结</h2><p>Openstack主要的组件部署不复杂，文档目前也已经比较成熟，只不过涉及到linux和python dev相关内容较多，细节容易出错，多动动手基本也可以很快熟悉起来。但如果要深入内部，还得从log、运行原理等切入，直至跟进组件社区开发状态和进展，非一日之功。</p>
<p>参考：</p>
<ol>
<li><a href="http://docs.openstack.org/icehouse/" title="Openstack docs" target="_blank" rel="external">Openstack docs</a></li>
<li><a href="http://promisejohn.github.io/2015/04/15/PythonDevEnvSetting/" title="Python开发环境搭建">Python开发环境搭建</a></li>
<li><a href="http://techglimpse.com/openstack-installation-errors-solutions/" title="openstack安装错误方案" target="_blank" rel="external">openstack安装错误方案</a></li>
<li><a href="http://www.gossamer-threads.com/lists/openstack/operators/34627" title="Problem configuring openvswitch br-ex" target="_blank" rel="external">Problem configuring openvswitch br-ex</a></li>
<li><a href="https://www.rdoproject.org/Neutron_with_existing_external_network" title="Neutron_with_existing_external_network" target="_blank" rel="external">Neutron_with_existing_external_network</a></li>
<li><a href="http://docs.openstack.org/openstack-ops/content/network_troubleshooting.html" title="Network troubleshooting" target="_blank" rel="external">网络问题排查方法</a></li>
<li><a href="http://docs.openstack.org/admin-guide-cloud/content/under_the_hood_openvswitch.html" title="Networking Openvswitch on Openstack" target="_blank" rel="external">Networking Openvswitch on Openstack</a></li>
</ol>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Tech/">Tech</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/ceilometer/">ceilometer</a><a href="/tags/cinder/">cinder</a><a href="/tags/glance/">glance</a><a href="/tags/neutron/">neutron</a><a href="/tags/nova/">nova</a><a href="/tags/openstack/">openstack</a><a href="/tags/swift/">swift</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://promisejohn.github.io/2015/05/07/HelloOpenstack/" data-title="Openstack安装部署 | Promise John" data-tsina="1978495541" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2015/05/11/BuildKVMImages/" title="BuildKVMImages">
  <strong>上一篇：</strong><br/>
  <span>
  BuildKVMImages</span>
</a>
</div>


<div class="next">
<a href="/2015/04/17/RubyDevEnvSetting/"  title="Ruby开发环境搭建">
 <strong>下一篇：</strong><br/> 
 <span>Ruby开发环境搭建
</span>
</a>
</div>

</nav>

	
<section id="comments" class="comment">
	<div class="ds-thread" data-thread-key="2015/05/07/HelloOpenstack/" data-title="Openstack安装部署" data-url="http://promisejohn.github.io/2015/05/07/HelloOpenstack/"></div>
</section>


</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#参考架构及部署规划"><span class="toc-number">1.</span> <span class="toc-text">参考架构及部署规划</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基础环境配置"><span class="toc-number">2.</span> <span class="toc-text">基础环境配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Network_staff"><span class="toc-number">2.1.</span> <span class="toc-text">Network staff</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#配置远程登录，使用~/-ssh/config来简化远程登录操作（免密码验证）："><span class="toc-number">2.1.1.</span> <span class="toc-text">配置远程登录，使用~/.ssh/config来简化远程登录操作（免密码验证）：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置主机HostName及/etc/hosts"><span class="toc-number">2.2.</span> <span class="toc-text">配置主机HostName及/etc/hosts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置时区，启用NTP服务"><span class="toc-number">2.3.</span> <span class="toc-text">配置时区，启用NTP服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#密码准备"><span class="toc-number">2.4.</span> <span class="toc-text">密码准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据库安装配置"><span class="toc-number">2.5.</span> <span class="toc-text">数据库安装配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#消息服务安装配置"><span class="toc-number">2.6.</span> <span class="toc-text">消息服务安装配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#yum第三方源添加"><span class="toc-number">2.7.</span> <span class="toc-text">yum第三方源添加</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ID_Service:_Keystone"><span class="toc-number">3.</span> <span class="toc-text">ID Service: Keystone</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#在oskeystone上安装keystone服务："><span class="toc-number">3.1.</span> <span class="toc-text">在oskeystone上安装keystone服务：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#定义User,_tenant,_role"><span class="toc-number">3.2.</span> <span class="toc-text">定义User, tenant, role</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Openstack_Service_Clients"><span class="toc-number">4.</span> <span class="toc-text">Openstack Service Clients</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Images_Service:_Glance"><span class="toc-number">5.</span> <span class="toc-text">Images Service: Glance</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装Glance_Service"><span class="toc-number">5.1.</span> <span class="toc-text">安装Glance Service</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建Glance服务权限："><span class="toc-number">5.2.</span> <span class="toc-text">创建Glance服务权限：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#验证Glance_Service"><span class="toc-number">5.3.</span> <span class="toc-text">验证Glance Service</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Compute_Service:_Nova"><span class="toc-number">6.</span> <span class="toc-text">Compute Service: Nova</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Nova安装"><span class="toc-number">6.1.</span> <span class="toc-text">Nova安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署计算节点："><span class="toc-number">6.2.</span> <span class="toc-text">部署计算节点：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Network_Service:_Neutron_with_ML2"><span class="toc-number">7.</span> <span class="toc-text">Network Service: Neutron with ML2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#部署Neutron管理端"><span class="toc-number">7.1.</span> <span class="toc-text">部署Neutron管理端</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#在oskeystone上准备Neutron数据库："><span class="toc-number">7.1.1.</span> <span class="toc-text">在oskeystone上准备Neutron数据库：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#在oscontroller上部署配置Neutron服务端："><span class="toc-number">7.1.2.</span> <span class="toc-text">在oscontroller上部署配置Neutron服务端：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#在oscontroller上：配置Nova管理端使用Neutron管理网络："><span class="toc-number">7.1.3.</span> <span class="toc-text">在oscontroller上：配置Nova管理端使用Neutron管理网络：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#在oscontroller上启动Neutron服务："><span class="toc-number">7.1.4.</span> <span class="toc-text">在oscontroller上启动Neutron服务：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在osnetwork上配置Linux转发及Neutron_Agent"><span class="toc-number">7.2.</span> <span class="toc-text">在osnetwork上配置Linux转发及Neutron Agent</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#启用IP转发"><span class="toc-number">7.2.1.</span> <span class="toc-text">启用IP转发</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#部署配置Neutron及ML2,_OVS,_L3："><span class="toc-number">7.2.2.</span> <span class="toc-text">部署配置Neutron及ML2, OVS, L3：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置osnetwork上的dhcp组件："><span class="toc-number">7.2.3.</span> <span class="toc-text">配置osnetwork上的dhcp组件：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置metadata_agent组件："><span class="toc-number">7.2.4.</span> <span class="toc-text">配置metadata agent组件：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置oscontroller上的nova："><span class="toc-number">7.2.5.</span> <span class="toc-text">配置oscontroller上的nova：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置osnetwork上的ML2,_OVS插件："><span class="toc-number">7.2.6.</span> <span class="toc-text">配置osnetwork上的ML2, OVS插件：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动OVS，添加br-int,_br-ex为内部和外部bridge："><span class="toc-number">7.2.7.</span> <span class="toc-text">启动OVS，添加br-int, br-ex为内部和外部bridge：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动Neutron_Agent服务："><span class="toc-number">7.2.8.</span> <span class="toc-text">启动Neutron Agent服务：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在oscompute1和oscompute2上配置Linux转发及Neutron_Agent"><span class="toc-number">7.3.</span> <span class="toc-text">在oscompute1和oscompute2上配置Linux转发及Neutron Agent</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#启用Linux转发"><span class="toc-number">7.3.1.</span> <span class="toc-text">启用Linux转发</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#安装部署Neutron_ML2和OVS"><span class="toc-number">7.3.2.</span> <span class="toc-text">安装部署Neutron ML2和OVS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置ML2"><span class="toc-number">7.3.3.</span> <span class="toc-text">配置ML2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置OVS"><span class="toc-number">7.3.4.</span> <span class="toc-text">配置OVS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置Nova-Compute"><span class="toc-number">7.3.5.</span> <span class="toc-text">配置Nova-Compute</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#修改neutron-openvswitch-agent使用plugin-ini配置："><span class="toc-number">7.3.6.</span> <span class="toc-text">修改neutron-openvswitch-agent使用plugin.ini配置：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动nova-computer,neutron-openvswitch-agent进程"><span class="toc-number">7.3.7.</span> <span class="toc-text">启动nova-computer,neutron-openvswitch-agent进程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#初始化虚拟机的网络"><span class="toc-number">7.4.</span> <span class="toc-text">初始化虚拟机的网络</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#虚拟机网络流量通道"><span class="toc-number">7.5.</span> <span class="toc-text">虚拟机网络流量通道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删除或变更GRE通道"><span class="toc-number">7.6.</span> <span class="toc-text">删除或变更GRE通道</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dashboard"><span class="toc-number">8.</span> <span class="toc-text">Dashboard</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Block_Service:_Cinder"><span class="toc-number">9.</span> <span class="toc-text">Block Service: Cinder</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#在oscontroller上安装Cinder_Service"><span class="toc-number">9.1.</span> <span class="toc-text">在oscontroller上安装Cinder Service</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在osceph0上部署一个临时存储节点"><span class="toc-number">9.2.</span> <span class="toc-text">在osceph0上部署一个临时存储节点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建Instance云主机"><span class="toc-number">10.</span> <span class="toc-text">创建Instance云主机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Object_Service:_Swift"><span class="toc-number">11.</span> <span class="toc-text">Object Service: Swift</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建swift账号，在keystone上注册服务："><span class="toc-number">11.1.</span> <span class="toc-text">创建swift账号，在keystone上注册服务：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署存储节点"><span class="toc-number">11.2.</span> <span class="toc-text">部署存储节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在osswift0上部署proxy_server"><span class="toc-number">11.3.</span> <span class="toc-text">在osswift0上部署proxy server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动服务："><span class="toc-number">11.4.</span> <span class="toc-text">启动服务：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Heat"><span class="toc-number">12.</span> <span class="toc-text">Heat</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Ceilometer"><span class="toc-number">13.</span> <span class="toc-text">Ceilometer</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#在osmeter部署Ceilmeter_Service："><span class="toc-number">13.1.</span> <span class="toc-text">在osmeter部署Ceilmeter Service：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#给计算节点部署Agent："><span class="toc-number">13.2.</span> <span class="toc-text">给计算节点部署Agent：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#给Glance、Cinder、Swift部署Agent："><span class="toc-number">13.3.</span> <span class="toc-text">给Glance、Cinder、Swift部署Agent：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#检验ceilometer效果"><span class="toc-number">13.4.</span> <span class="toc-text">检验ceilometer效果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">14.</span> <span class="toc-text">总结</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/Tech/" title="Tech">Tech<sup>11</sup></a></li>
		  
		
		  
		
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/dev/" title="dev">dev<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/vagrant/" title="vagrant">vagrant<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/虚拟化/" title="虚拟化">虚拟化<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/docker/" title="docker">docker<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/glance/" title="glance">glance<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/linux/" title="linux">linux<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/hadoop/" title="hadoop">hadoop<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/ruby/" title="ruby">ruby<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/openstack/" title="openstack">openstack<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/nova/" title="nova">nova<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/neutron/" title="neutron">neutron<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/cinder/" title="cinder">cinder<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/saltstack/" title="saltstack">saltstack<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/ceilometer/" title="ceilometer">ceilometer<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/swift/" title="swift">swift<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/hexo/" title="hexo">hexo<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/hdfs/" title="hdfs">hdfs<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/java/" title="java">java<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/ambari/" title="ambari">ambari<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/hue/" title="hue">hue<sup>1</sup></a></li>
			
		
		</ul>
</div>


  
  <div class="archiveslist">
    <p class="asidetitle"><a href="/archives">归档</a></p>
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">六月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">五月 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">四月 2015</a><span class="archive-list-count">6</span></li></ul>
  </div>


  

<div class="doubanshow">
<p class="asidetitle">豆瓣秀</p>
<div>
<script type="text/javascript" src="http://www.douban.com/service/badge/promisejohn/?show=collection&amp;n=12&amp;columns=3&amp;hidelogo=yes&amp;hideself=yes&amp;cat=book|movie" ></script>
</div>
</div>


  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=1978495541&verifier=f272f916&dpc=1"></iframe>
</div>


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.youxiuboke.com/" target="_blank" title=" 前端优秀案例">优秀博客</a>
            
          </li>
        
          <li>
            
            	<a href="https://coding.net" target="_blank" title=" 一个代码托管PaaS平台">Coding</a>
            
          </li>
        
          <li>
            
            	<a href="http://hexo.io/docs/" target="_blank" title=" Hexo官方文档">Hexo Docs</a>
            
          </li>
        
    </ul>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Like it or not <br/>
			This is my blog.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/1978495541" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/promisejohn" target="_blank" class="icon-github" title="github"></a>
		
		
		
		<a href="https://twitter.com/promisejohn19" target="_blank" class="icon-twitter" title="twitter"></a>
		
		
		<a href="https://www.facebook.com/john.promise.98" target="_blank" class="icon-facebook" title="facebook"></a>
		
		
		<a href="https://www.linkedin.com/in/promisejohn" target="_blank" class="icon-linkedin" title="linkedin"></a>
		
		
		<a href="https://www.douban.com/people/promisejohn" target="_blank" class="icon-douban" title="豆瓣"></a>
		
		
		<a href="https://www.zhihu.com/people/john-promise" target="_blank" class="icon-zhihu" title="知乎"></a>
		
		
		
		<a href="mailto:promise.john@gmail.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2015 
		
		<a href="http://promisejohn.github.io/about" target="_blank" title="promise john">promise john</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#nothing"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>



<script type="text/javascript">
  var duoshuoQuery = {short_name:"promisejohn"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 







<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->





<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
